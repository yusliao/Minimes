@page "/weighing/records"
@attribute [Microsoft.AspNetCore.Authorization.Authorize(Policy = "Operator")]
@using Microsoft.Extensions.Localization
@using Minimes.Application.Interfaces
@using Minimes.Application.DTOs.WeighingRecord
@using Minimes.Domain.Enums
@using Minimes.Web.Resources
@using System.Security.Claims
@inject IStringLocalizer<SharedResource> L
@inject IWeighingRecordService WeighingRecordService
@inject IExcelExportService ExcelExportService
@inject IJSRuntime JSRuntime

<PageTitle>@L["Records_Title"]</PageTitle>

<h3>ğŸ“‹ @L["Records_Title"]</h3>

@if (!isAdmin)
{
    <div class="alert alert-info mb-3">
        <span class="oi oi-info me-2"></span>
        @L["Records_MyRecordsHint"]
    </div>
}

<!-- æŸ¥è¯¢æ¡ä»¶ -->
<div class="card mb-3">
    <div class="card-body">
        <div class="row g-3">
            <div class="col-md-3">
                <label class="form-label">@L["Weighing_Barcode"]</label>
                <input type="text" class="form-control" @bind="queryRequest.Barcode" placeholder="@L["Records_BarcodePlaceholder"]" />
            </div>
            <div class="col-md-2">
                <label class="form-label">@L["Weighing_Stage"]</label>
                <select class="form-select" @bind="selectedProcessStageId">
                    <option value="">@L["Records_AllStages"]</option>
                    <option value="1">@L["Stage_Receiving"]</option>
                    <option value="2">@L["Stage_Processing"]</option>
                    <option value="3">@L["Stage_Shipping"]</option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">@L["Records_StartDate"]</label>
                <input type="date" class="form-control" @bind="startDateInput" />
            </div>
            <div class="col-md-2">
                <label class="form-label">@L["Records_EndDate"]</label>
                <input type="date" class="form-control" @bind="endDateInput" />
            </div>
            <div class="col-md-6 d-flex align-items-end gap-2">
                <button class="btn btn-primary flex-fill" @onclick="Search">
                    <span class="oi oi-magnifying-glass"></span> @L["Btn_Search"]
                </button>
                <button class="btn btn-success flex-fill" @onclick="ExportToExcel" disabled="@isLoading">
                    <span class="oi oi-data-transfer-download"></span> å¯¼å‡ºExcel
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ç»Ÿè®¡ä¿¡æ¯ -->
@if (records.Any())
{
    <div class="row mb-3">
        <div class="col-md-6">
            <div class="card text-center">
                <div class="card-body">
                    <h6 class="text-muted">@L["Records_TotalRecords"]</h6>
                    <h3>@totalCount @L["Weighing_Records"]</h3>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card text-center">
                <div class="card-body">
                    <h6 class="text-muted">@L["Weighing_TotalWeight"]</h6>
                    <h3>@records.Sum(r => r.WeightInPounds).ToString("F3") lb</h3>
                </div>
            </div>
        </div>
    </div>
}

<!-- è®°å½•åˆ—è¡¨ -->
<div class="card">
    <div class="card-body">
        @if (isLoading)
        {
            <p class="text-center text-muted">@L["Status_Loading"]</p>
        }
        else if (!records.Any())
        {
            <p class="text-center text-muted">@L["Weighing_NoRecords"]</p>
        }
        else
        {
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>@L["Records_Time"]</th>
                            <th>@L["Weighing_Barcode"]</th>
                            <th>è‚‰ç±»ç±»å‹</th>
                            <th>ç¼–å·</th>
                            <th>@L["Weighing_Stage"]</th>
                            <th>@L["Weighing_Weight"] (lb)</th>
                            <th>@L["Records_Operator"]</th>
                            <th>@L["Weighing_Remark"]</th>
                            <th>@L["Records_Action"]</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var record in records)
                        {
                            <tr>
                                <td>@record.CreatedAt.ToString("MM-dd HH:mm")</td>
                                <td><code>@record.Barcode</code></td>
                                <td><span class="badge bg-success">@record.MeatTypeName</span></td>
                                <td><strong>@record.Code</strong></td>
                                <td><span class="badge bg-info">@GetLocalizedStageName(record.ProcessStageName)</span></td>
                                <td>@record.WeightInPounds.ToString("F3")</td>
                                <td>@record.CreatedBy</td>
                                <td>@record.Remarks</td>
                                <td>
                                    <button class="btn btn-sm btn-danger" @onclick="() => DeleteRecord(record.Id)">
                                        <span class="oi oi-trash"></span>
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <!-- åˆ†é¡µ -->
            <nav>
                <ul class="pagination justify-content-center">
                    <li class="page-item @(queryRequest.PageNumber == 1 ? "disabled" : "")">
                        <button class="page-link" @onclick="() => ChangePage(queryRequest.PageNumber - 1)">@L["Records_PrevPage"]</button>
                    </li>

                    @for (int i = Math.Max(1, queryRequest.PageNumber - 2); i <= Math.Min(totalPages, queryRequest.PageNumber + 2); i++)
                    {
                        var pageNum = i;
                        <li class="page-item @(pageNum == queryRequest.PageNumber ? "active" : "")">
                            <button class="page-link" @onclick="() => ChangePage(pageNum)">@pageNum</button>
                        </li>
                    }

                    <li class="page-item @(queryRequest.PageNumber >= totalPages ? "disabled" : "")">
                        <button class="page-link" @onclick="() => ChangePage(queryRequest.PageNumber + 1)">@L["Records_NextPage"]</button>
                    </li>
                </ul>
            </nav>
        }
    </div>
</div>

@code {
    [CascadingParameter]
    private Task<AuthenticationState>? AuthenticationStateTask { get; set; }

    private WeighingRecordQueryRequest queryRequest = new();
    private List<WeighingRecordResponse> records = new();
    private int totalCount = 0;
    private int totalPages => (int)Math.Ceiling((double)totalCount / queryRequest.PageSize);

    private DateTime? startDateInput;
    private DateTime? endDateInput;
    private int? selectedProcessStageId; // å·¥åºIDè¿‡æ»¤
    private bool isLoading = false;

    // è§’è‰²å’Œç”¨æˆ·ä¿¡æ¯
    private bool isAdmin = false;
    private string currentUsername = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadUserRole();
        await Search();
    }

    private async Task LoadUserRole()
    {
        if (AuthenticationStateTask != null)
        {
            var authState = await AuthenticationStateTask;
            var user = authState.User;

            if (user.Identity?.IsAuthenticated == true)
            {
                currentUsername = user.FindFirst(ClaimTypes.Name)?.Value ?? string.Empty;
                // æ£€æŸ¥æ˜¯å¦æ˜¯ç®¡ç†å‘˜
                isAdmin = user.IsInRole("Administrator");

                // æ“ä½œå‘˜åªèƒ½æŸ¥çœ‹è‡ªå·±çš„è®°å½•
                if (!isAdmin && !string.IsNullOrEmpty(currentUsername))
                {
                    queryRequest.CreatedBy = currentUsername;
                }
            }
        }
    }

    private async Task Search()
    {
        isLoading = true;
        StateHasChanged();

        queryRequest.StartDate = startDateInput;
        queryRequest.EndDate = endDateInput;
        queryRequest.ProcessStageId = selectedProcessStageId;
        queryRequest.PageNumber = 1; // é‡ç½®åˆ°ç¬¬ä¸€é¡µ

        var (foundRecords, count) = await WeighingRecordService.QueryAsync(queryRequest);
        records = foundRecords;
        totalCount = count;

        isLoading = false;
        StateHasChanged();
    }

    private async Task ChangePage(int pageNumber)
    {
        if (pageNumber < 1 || pageNumber > totalPages)
        {
            return;
        }

        isLoading = true;
        queryRequest.PageNumber = pageNumber;

        var (foundRecords, count) = await WeighingRecordService.QueryAsync(queryRequest);
        records = foundRecords;
        totalCount = count;

        isLoading = false;
        StateHasChanged();
    }

    private async Task DeleteRecord(int id)
    {
        if (!await JSRuntime.InvokeAsync<bool>("confirm", L["Records_ConfirmDelete"].Value))
        {
            return;
        }

        var success = await WeighingRecordService.DeleteAsync(id);
        if (success)
        {
            await Search(); // é‡æ–°åŠ è½½åˆ—è¡¨
        }
    }

    private string GetLocalizedStageName(string stageName)
    {
        var normalized = stageName.ToLower().Trim();
        if (normalized.Contains("receiving") || normalized.Contains("å…¥åº“") || normalized.Contains("åŸæ–™"))
            return L["Stage_Receiving"];
        if (normalized.Contains("processing") || normalized.Contains("åŠ å·¥"))
            return L["Stage_Processing"];
        if (normalized.Contains("shipping") || normalized.Contains("å‡ºåº“") || normalized.Contains("æˆå“"))
            return L["Stage_Shipping"];
        return stageName;
    }

    private async Task ExportToExcel()
    {
        try
        {
            isLoading = true;
            StateHasChanged();

            // åˆ›å»ºå¯¼å‡ºæŸ¥è¯¢è¯·æ±‚ï¼ˆè·å–æ‰€æœ‰è®°å½•ï¼Œä¸åˆ†é¡µï¼‰
            var exportRequest = new WeighingRecordQueryRequest
            {
                Barcode = queryRequest.Barcode,
                ProcessStageId = queryRequest.ProcessStageId,
                StartDate = queryRequest.StartDate,
                EndDate = queryRequest.EndDate,
                CreatedBy = queryRequest.CreatedBy,
                PageNumber = 1,
                PageSize = 100000 // è®¾ç½®ä¸€ä¸ªå¾ˆå¤§çš„å€¼æ¥è·å–æ‰€æœ‰è®°å½•
            };

            var (allRecords, _) = await WeighingRecordService.QueryAsync(exportRequest);

            if (!allRecords.Any())
            {
                await JSRuntime.InvokeVoidAsync("alert", "æ²¡æœ‰æ•°æ®å¯ä»¥å¯¼å‡ºï¼");
                return;
            }

            // ç”ŸæˆExcelæ–‡ä»¶
            var excelBytes = await ExcelExportService.ExportWeighingRecordsAsync(allRecords);
            var base64 = Convert.ToBase64String(excelBytes);

            // ç”Ÿæˆæ–‡ä»¶å
            var fileName = $"ç§°é‡è®°å½•_{DateTime.Now:yyyyMMdd_HHmmss}.xlsx";
            if (!string.IsNullOrWhiteSpace(queryRequest.Barcode))
            {
                fileName = $"ç§°é‡è®°å½•_{queryRequest.Barcode}_{DateTime.Now:yyyyMMdd_HHmmss}.xlsx";
            }

            // ä¸‹è½½æ–‡ä»¶
            await JSRuntime.InvokeVoidAsync("downloadFile", fileName, base64);
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"å¯¼å‡ºå¤±è´¥ï¼š{ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }
}
