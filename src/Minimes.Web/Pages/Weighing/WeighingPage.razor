@page "/weighing"
@attribute [Microsoft.AspNetCore.Authorization.Authorize(Policy = "Operator")]
@using Microsoft.AspNetCore.SignalR.Client
@using Microsoft.Extensions.Localization
@using Microsoft.Extensions.Options
@using Minimes.Application.Interfaces
@using Minimes.Application.DTOs.WeighingRecord
@using Minimes.Application.Configuration
@using Minimes.Domain.Enums
@using Minimes.Application.Resources
@inject IStringLocalizer<SharedResource> L
@inject IWeighingRecordService WeighingRecordService
@inject IMeatTypeService MeatTypeService
@inject IQRCodeService QRCodeService
@inject IOptionsSnapshot<WeightValidationConfig> WeightConfig
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IJSRuntime JSRuntime
@implements IAsyncDisposable

<PageTitle>@L["Weighing_Title"]</PageTitle>

<!-- 响应式标题：PC完整显示，移动端简化 -->
<h3 class="mb-3">
    <span class="oi oi-dashboard" aria-hidden="true"></span> @L["Weighing_Title"]
    <span class="d-none d-md-inline text-muted fs-6">- @L["Weighing_Subtitle"]</span>
</h3>

<!-- 移动端：顶部快捷统计条 -->
<div class="d-md-none mb-3">
    <div class="card bg-light">
        <div class="card-body py-2">
            <div class="d-flex justify-content-between align-items-center">
                <div class="small">
                    @if (todaySummary != null)
                    {
                        <span class="me-3">📊 @L["Time_Today"] <strong>@todaySummary.TotalRecords</strong> @L["Weighing_Records"]</span>
                        <span>⚖️ <strong>@(todaySummary.TotalWeight.ToString("F1"))</strong> lb</span>
                    }
                </div>
                <button class="btn btn-sm btn-outline-secondary" type="button"
                        data-bs-toggle="collapse" data-bs-target="#mobileStats">
                    <span class="oi oi-chevron-bottom"></span>
                </button>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- 左侧/移动端全宽：当前称重区域 -->
    <div class="col-12 col-md-8 mb-3">
        <div class="card">
            <div class="card-header bg-primary text-white py-2">
                <h5 class="mb-0">📦 @L["Weighing_Current"]</h5>
            </div>
            <div class="card-body">
                <!-- 条码输入区域 -->
                <div class="mb-4">
                    <h6>@L["Weighing_Barcode"] <span class="text-danger">*</span></h6>
                    <div class="input-group input-group-lg">
                        <input type="text" class="form-control form-control-lg"
                               @ref="barcodeInput"
                               @bind="currentBarcode"
                               @bind:event="oninput"
                               @onkeydown="OnBarcodeKeyDown"
                               placeholder="@L["Weighing_BarcodePlaceholder"]" />
                    </div>
                    @if (!string.IsNullOrWhiteSpace(currentBarcode))
                    {
                        @if (parsedMeatTypeId > 0 && !string.IsNullOrWhiteSpace(parsedMeatTypeName))
                        {
                            <small class="text-success">
                                ✓ 二维码：@currentBarcode | 肉类：<strong>@parsedMeatTypeName</strong> | 编号：<strong>@parsedCode</strong>
                            </small>
                        }
                        else
                        {
                            <small class="text-warning">⚠️ 已输入条码：@currentBarcode（请按回车解析）</small>
                        }
                    }
                    else
                    {
                        <small class="text-muted">📱 @L["Weighing_BarcodeScanHint"]</small>
                    }
                </div>

                <!-- 重量输入区域 -->
                <div class="mb-4">
                    <h6>@L["Weighing_Weight"] <span class="text-danger">*</span></h6>
                    <div class="input-group input-group-lg">
                        <input type="number" class="form-control form-control-lg text-center"
                               @ref="weightInput"
                               @bind="manualWeightInput"
                               @bind:event="oninput"
                               @onkeydown="OnWeightKeyDown"
                               placeholder="@L["Weighing_WeightPlaceholder"]" step="0.001" min="0" />
                        <span class="input-group-text">lb</span>
                    </div>
                    @if (manualWeightInput > 0)
                    {
                        <small class="text-success">✓ @L["Weighing_Weight"]：@manualWeightInput.ToString("F3") lb</small>
                    }
                    else
                    {
                        <small class="text-muted">@L["Weighing_WeightHint"] (@WeightConfig.Value.MinWeightLb.ToString("F3") - @WeightConfig.Value.MaxWeightLb.ToString("F1") lb)</small>
                    }
                </div>

                <div class="mb-4">
                    <label class="form-label">@L["Weighing_Remark"]（@L["Weighing_Optional"]）</label>
                    <textarea class="form-control form-control-lg" @bind="remarks" rows="2" placeholder="@L["Weighing_RemarkPlaceholder"]"></textarea>
                </div>

                <!-- 保存按钮 -->
                <div class="d-grid gap-2">
                    @if (!string.IsNullOrEmpty(errorMessage))
                    {
                        <div class="alert alert-danger">
                            <strong>❌ </strong>@errorMessage
                        </div>
                    }
                    <button class="btn btn-success btn-lg" @onclick="SaveRecord">
                        <span class="oi oi-check"></span> @L["Weighing_SaveRecord"]
                    </button>
                    <button class="btn btn-outline-secondary" @onclick="ClearForm">
                        <span class="oi oi-reload"></span> @L["Weighing_Reset"]
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 右侧/移动端：统计和最近记录 -->
    <div class="col-12 col-md-4">
        <!-- 移动端折叠内容 -->
        <div class="collapse d-md-block" id="mobileStats">
            <!-- 今日统计 -->
            <div class="card mb-3">
                <div class="card-header bg-info text-white py-2">
                    <h6 class="mb-0">📊 @L["Weighing_TodayStats"]</h6>
                </div>
                <div class="card-body py-2">
                    @if (todaySummary != null)
                    {
                        <div class="row text-center">
                            <div class="col-4">
                                <div class="fs-4 fw-bold text-primary">@todaySummary.TotalRecords</div>
                                <small class="text-muted">@L["Weighing_RecordCount"]</small>
                            </div>
                            <div class="col-4">
                                <div class="fs-4 fw-bold text-success">@(todaySummary.TotalWeight.ToString("F1"))</div>
                                <small class="text-muted">@L["Weighing_TotalWeight"]</small>
                            </div>
                            <div class="col-4">
                                <div class="fs-4 fw-bold text-info">@todaySummary.UniqueBarcodes</div>
                                <small class="text-muted">@L["Weighing_BarcodeCount"]</small>
                            </div>
                        </div>
                    }
                    else
                    {
                        <p class="text-muted mb-0 text-center">@L["Status_Loading"]</p>
                    }
                </div>
            </div>

            <!-- 最近记录 -->
            <div class="card">
                <div class="card-header bg-secondary text-white py-2">
                    <h6 class="mb-0">📝 @L["Weighing_RecentRecords"]</h6>
                </div>
                <div class="card-body p-0" style="max-height: 300px; overflow-y: auto;">
                    @if (recentRecords.Any())
                    {
                        <div class="list-group list-group-flush">
                            @foreach (var record in recentRecords)
                            {
                                <div class="list-group-item py-2 px-3">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <code class="fw-bold">@record.Barcode</code>
                                        </div>
                                        <div class="text-end">
                                            <div class="fw-bold">@record.WeightInPounds.ToString("F2") lb</div>
                                            <small class="text-muted">@record.CreatedAt.ToString("HH:mm")</small>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <p class="text-muted text-center py-3 mb-0">@L["Weighing_NoRecords"]</p>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    // SignalR连接（用于扫码枪）
    private HubConnection? hubConnection;

    // 输入框引用（用于自动聚焦）
    private ElementReference barcodeInput;
    private ElementReference weightInput;

    // 条码
    private string currentBarcode = string.Empty;
    private string parsedCode = string.Empty;  // 从二维码解析出的用户编号
    private int parsedMeatTypeId = 0;  // 从二维码解析出的肉类类型ID
    private string parsedMeatTypeName = string.Empty;  // 肉类类型名称（用于显示）

    // 重量状态
    private decimal manualWeightInput = 0;  // 手动输入的重量

    // 其他字段
    private string? remarks;
    private string? errorMessage;  // 错误提示
    private bool isSaving = false;  // 防止重复提交标志

    // 统计数据
    private TodaySummary? todaySummary;
    private List<WeighingRecordResponse> recentRecords = new();

    // 保存条件：有条码 + 解析成功 + 重量大于0
    private bool CanSave => !string.IsNullOrWhiteSpace(currentBarcode)
        && parsedMeatTypeId > 0
        && !string.IsNullOrWhiteSpace(parsedCode)
        && manualWeightInput > 0;

    protected override async Task OnInitializedAsync()
    {
        var stopwatch = System.Diagnostics.Stopwatch.StartNew();
        Console.WriteLine("=== 称重页面初始化开始 ===");

        // 初始化SignalR连接对象（不启动连接，避免阻塞数据加载）
        hubConnection = new HubConnectionBuilder()
            .WithUrl(Navigation.ToAbsoluteUri("/hardwareHub"))
            .Build();

        // 订阅扫码事件（保留，扫码枪还是有用的）
        hubConnection.On<object>("ReceiveBarcode", (data) =>
        {
            var json = System.Text.Json.JsonSerializer.Serialize(data);
            var barcodeData = System.Text.Json.JsonSerializer.Deserialize<BarcodeData>(json);

            if (barcodeData != null && !string.IsNullOrEmpty(barcodeData.barcode))
            {
                currentBarcode = barcodeData.barcode;
                InvokeAsync(StateHasChanged);
            }
        });

        Console.WriteLine($"[{stopwatch.ElapsedMilliseconds}ms] SignalR连接对象创建完成");

        // 性能优化：先加载数据，SignalR连接在OnAfterRenderAsync中后台启动
        // 顺序加载今日统计和最近记录（避免DbContext并发错误）
        await LoadTodaySummary();
        Console.WriteLine($"[{stopwatch.ElapsedMilliseconds}ms] 今日统计加载完成");

        await LoadRecentRecords();
        Console.WriteLine($"[{stopwatch.ElapsedMilliseconds}ms] 最近记录加载完成");

        stopwatch.Stop();
        Console.WriteLine($"=== 称重页面数据加载完成，总耗时: {stopwatch.ElapsedMilliseconds}ms ===");
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // 页面首次加载，自动聚焦到条码输入框
            await FocusBarcodeInput();

            // 性能优化：在后台启动SignalR连接，不阻塞数据显示
            if (hubConnection != null)
            {
                _ = Task.Run(async () =>
                {
                    var stopwatch = System.Diagnostics.Stopwatch.StartNew();
                    Console.WriteLine("=== 开始后台连接SignalR ===");

                    try
                    {
                        await hubConnection.StartAsync();
                        Console.WriteLine($"[{stopwatch.ElapsedMilliseconds}ms] SignalR连接启动成功");
                    }
                    catch (Exception ex)
                    {
                        Console.WriteLine($"[{stopwatch.ElapsedMilliseconds}ms] SignalR连接失败: {ex.Message}");
                    }
                });
            }
        }
    }

    private async Task FocusBarcodeInput()
    {
        try
        {
            // 使用ElementReference直接聚焦，更可靠
            await barcodeInput.FocusAsync();
        }
        catch { /* 忽略聚焦失败 */ }
    }

    private async Task FocusWeightInput()
    {
        try
        {
            // 使用ElementReference直接聚焦，更可靠
            await weightInput.FocusAsync();
        }
        catch { /* 忽略聚焦失败 */ }
    }

    private async Task LoadTodaySummary()
    {
        todaySummary = await WeighingRecordService.GetTodaySummaryAsync();
    }

    private async Task LoadRecentRecords()
    {
        var query = new WeighingRecordQueryRequest
        {
            PageNumber = 1,
            PageSize = 10
        };

        var (records, _) = await WeighingRecordService.QueryAsync(query);
        recentRecords = records;
    }

    // 条码输入框回车：解析条码并跳转到重量输入框
    private async Task OnBarcodeKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !string.IsNullOrWhiteSpace(currentBarcode))
        {
            await ParseBarcode();

            // 【修复Bug】只有解析成功才切换焦点到重量框，否则停留在条码框让用户重新输入
            if (parsedMeatTypeId > 0 && !string.IsNullOrWhiteSpace(parsedCode))
            {
                await FocusWeightInput();
            }
        }
    }

    // 解析二维码内容（格式：PORK-001）
    private async Task ParseBarcode()
    {
        try
        {
            var barcode = currentBarcode.Trim();

            // 检查格式：必须包含"-"分隔符
            if (!barcode.Contains("-"))
            {
                errorMessage = "二维码格式错误！正确格式：PORK-001";
                parsedCode = string.Empty;
                parsedMeatTypeId = 0;
                parsedMeatTypeName = string.Empty;
                return;
            }

            // 【关键检查】先检查二维码是否在二维码管理中存在
            var qrCode = await QRCodeService.GetByContentAsync(barcode);
            if (qrCode == null)
            {
                errorMessage = L["QRCode_NotFound"];
                parsedCode = string.Empty;
                parsedMeatTypeId = 0;
                parsedMeatTypeName = string.Empty;
                return;
            }

            // 【关键检查】检查二维码是否激活
            if (!qrCode.IsActive)
            {
                errorMessage = L["QRCode_Inactive"];
                parsedCode = string.Empty;
                parsedMeatTypeId = 0;
                parsedMeatTypeName = string.Empty;
                return;
            }

            // 拆分二维码：PORK-001 → ["PORK", "001"]
            var parts = barcode.Split('-', 2);
            var meatTypeCode = parts[0].Trim().ToUpper();
            var code = parts[1].Trim();

            // 根据肉类类型代码查询肉类类型
            var meatType = await MeatTypeService.GetByCodeAsync(meatTypeCode);
            if (meatType == null)
            {
                errorMessage = $"肉类类型代码 '{meatTypeCode}' 不存在！";
                parsedCode = string.Empty;
                parsedMeatTypeId = 0;
                parsedMeatTypeName = string.Empty;
                return;
            }

            // 检查肉类类型是否激活
            if (!meatType.IsActive)
            {
                errorMessage = $"肉类类型 '{meatType.Name}' 已停用！";
                parsedCode = string.Empty;
                parsedMeatTypeId = 0;
                parsedMeatTypeName = string.Empty;
                return;
            }

            // 解析成功
            parsedCode = code;
            parsedMeatTypeId = meatType.Id;
            parsedMeatTypeName = meatType.Name;
            errorMessage = null;
        }
        catch (Exception ex)
        {
            errorMessage = $"解析二维码失败：{ex.Message}";
            parsedCode = string.Empty;
            parsedMeatTypeId = 0;
            parsedMeatTypeName = string.Empty;
        }
    }

    // 重量输入框回车：校验后保存
    private async Task OnWeightKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            // 【修复Bug】校验重量是否大于0
            if (manualWeightInput <= 0)
            {
                errorMessage = L["Weighing_ErrorWeightRequired"];
                StateHasChanged();
                return;
            }

            // 【新增校验】校验重量上下限
            var minWeight = WeightConfig.Value.MinWeightLb;
            var maxWeight = WeightConfig.Value.MaxWeightLb;

            if (manualWeightInput < minWeight)
            {
                errorMessage = $"重量过轻！最小重量为 {minWeight:F3} 磅";
                StateHasChanged();
                return;
            }

            if (manualWeightInput > maxWeight)
            {
                errorMessage = $"重量过重！最大重量为 {maxWeight:F1} 磅";
                StateHasChanged();
                return;
            }

            // 【修复Bug】校验条码是否已解析成功
            if (parsedMeatTypeId == 0 || string.IsNullOrWhiteSpace(parsedCode))
            {
                errorMessage = "请先输入有效的二维码并按回车解析！";
                StateHasChanged();
                return;
            }

            // 校验通过，保存记录
            await SaveRecord();
        }
    }

    private async Task SaveRecord()
    {
        // 防止重复提交
        if (isSaving)
        {
            return;
        }

        errorMessage = null;
        isSaving = true;  // 锁定，防止重复提交

        try
        {
            // 验证条码
            if (string.IsNullOrWhiteSpace(currentBarcode))
            {
                errorMessage = L["Weighing_ErrorBarcodeRequired"];
                return;
            }

            // 验证重量
            if (manualWeightInput <= 0)
            {
                errorMessage = L["Weighing_ErrorWeightRequired"];
                return;
            }

            // 验证二维码解析结果
            if (parsedMeatTypeId == 0 || string.IsNullOrWhiteSpace(parsedCode))
            {
                errorMessage = "请先输入有效的二维码并按回车解析！";
                return;
            }
            // 获取当前登录用户
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var currentUser = authState.User.Identity?.Name ?? "Unknown";

            var request = new CreateWeighingRecordRequest
            {
                Barcode = currentBarcode.Trim(),
                Code = parsedCode,
                MeatTypeId = parsedMeatTypeId,
                Weight = manualWeightInput,
                Remarks = remarks
            };

            await WeighingRecordService.CreateAsync(request, currentUser);

            await LoadTodaySummary();
            await LoadRecentRecords();

            // 清空，准备下一次
            currentBarcode = string.Empty;
            parsedCode = string.Empty;
            parsedMeatTypeId = 0;
            parsedMeatTypeName = string.Empty;
            manualWeightInput = 0;
            remarks = null;

            StateHasChanged();

            // 保存成功后自动聚焦回条码输入框，准备下一次扫码
            await FocusBarcodeInput();
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
            StateHasChanged();
        }
        finally
        {
            isSaving = false;  // 解锁，允许下一次提交
        }
    }

    private void ClearForm()
    {
        currentBarcode = string.Empty;
        parsedCode = string.Empty;
        parsedMeatTypeId = 0;
        parsedMeatTypeName = string.Empty;
        manualWeightInput = 0;
        remarks = null;
        errorMessage = null;
        StateHasChanged();
    }

    public async ValueTask DisposeAsync()
    {
        if (hubConnection != null)
        {
            await hubConnection.DisposeAsync();
        }
    }

    private class BarcodeData
    {
        public string barcode { get; set; } = string.Empty;
    }
}
