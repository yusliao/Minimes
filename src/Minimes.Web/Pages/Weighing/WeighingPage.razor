@page "/weighing"
@attribute [Microsoft.AspNetCore.Authorization.Authorize(Policy = "Operator")]
@using Microsoft.AspNetCore.SignalR.Client
@using Microsoft.Extensions.Localization
@using Minimes.Application.Interfaces
@using Minimes.Application.DTOs.WeighingRecord
@using Minimes.Domain.Enums
@using Minimes.Application.Resources
@inject IStringLocalizer<SharedResource> L
@inject IWeighingRecordService WeighingRecordService
@inject IMeatTypeService MeatTypeService
@inject IQRCodeService QRCodeService
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IJSRuntime JSRuntime
@implements IAsyncDisposable

<PageTitle>@L["Weighing_Title"]</PageTitle>

<!-- å“åº”å¼æ ‡é¢˜ï¼šPCå®Œæ•´æ˜¾ç¤ºï¼Œç§»åŠ¨ç«¯ç®€åŒ– -->
<h3 class="mb-3">
    <span class="oi oi-scale" aria-hidden="true"></span> @L["Weighing_Title"]
    <span class="d-none d-md-inline text-muted fs-6">- @L["Weighing_Subtitle"]</span>
</h3>

<!-- ç§»åŠ¨ç«¯ï¼šé¡¶éƒ¨å¿«æ·ç»Ÿè®¡æ¡ -->
<div class="d-md-none mb-3">
    <div class="card bg-light">
        <div class="card-body py-2">
            <div class="d-flex justify-content-between align-items-center">
                <div class="small">
                    @if (todaySummary != null)
                    {
                        <span class="me-3">ğŸ“Š @L["Time_Today"] <strong>@todaySummary.TotalRecords</strong> @L["Weighing_Records"]</span>
                        <span>âš–ï¸ <strong>@(todaySummary.TotalWeight.ToString("F1"))</strong> lb</span>
                    }
                </div>
                <button class="btn btn-sm btn-outline-secondary" type="button"
                        data-bs-toggle="collapse" data-bs-target="#mobileStats">
                    <span class="oi oi-chevron-bottom"></span>
                </button>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- å·¦ä¾§/ç§»åŠ¨ç«¯å…¨å®½ï¼šå½“å‰ç§°é‡åŒºåŸŸ -->
    <div class="col-12 col-md-8 mb-3">
        <div class="card">
            <div class="card-header bg-primary text-white py-2">
                <h5 class="mb-0">ğŸ“¦ @L["Weighing_Current"]</h5>
            </div>
            <div class="card-body">
                <!-- æ¡ç è¾“å…¥åŒºåŸŸ -->
                <div class="mb-4">
                    <h6>@L["Weighing_Barcode"] <span class="text-danger">*</span></h6>
                    <div class="input-group input-group-lg">
                        <input type="text" class="form-control form-control-lg"
                               @ref="barcodeInput"
                               @bind="currentBarcode"
                               @bind:event="oninput"
                               @onkeydown="OnBarcodeKeyDown"
                               placeholder="@L["Weighing_BarcodePlaceholder"]" />
                    </div>
                    @if (!string.IsNullOrWhiteSpace(currentBarcode))
                    {
                        @if (parsedMeatTypeId > 0 && !string.IsNullOrWhiteSpace(parsedMeatTypeName))
                        {
                            <small class="text-success">
                                âœ“ äºŒç»´ç ï¼š@currentBarcode | è‚‰ç±»ï¼š<strong>@parsedMeatTypeName</strong> | ç¼–å·ï¼š<strong>@parsedCode</strong>
                            </small>
                        }
                        else
                        {
                            <small class="text-warning">âš ï¸ å·²è¾“å…¥æ¡ç ï¼š@currentBarcodeï¼ˆè¯·æŒ‰å›è½¦è§£æï¼‰</small>
                        }
                    }
                    else
                    {
                        <small class="text-muted">ğŸ“± @L["Weighing_BarcodeScanHint"]</small>
                    }
                </div>

                <!-- é‡é‡è¾“å…¥åŒºåŸŸ -->
                <div class="mb-4">
                    <h6>@L["Weighing_Weight"] <span class="text-danger">*</span></h6>
                    <div class="input-group input-group-lg">
                        <input type="number" class="form-control form-control-lg text-center"
                               @ref="weightInput"
                               @bind="manualWeightInput"
                               @onkeydown="OnWeightKeyDown"
                               placeholder="@L["Weighing_WeightPlaceholder"]" step="0.001" min="0" />
                        <span class="input-group-text">lb</span>
                    </div>
                    @if (manualWeightInput > 0)
                    {
                        <small class="text-success">âœ“ @L["Weighing_Weight"]ï¼š@manualWeightInput.ToString("F3") lb</small>
                    }
                    else
                    {
                        <small class="text-muted">@L["Weighing_WeightHint"]</small>
                    }
                </div>

                <div class="mb-4">
                    <label class="form-label">@L["Weighing_Remark"]ï¼ˆ@L["Weighing_Optional"]ï¼‰</label>
                    <textarea class="form-control form-control-lg" @bind="remarks" rows="2" placeholder="@L["Weighing_RemarkPlaceholder"]"></textarea>
                </div>

                <!-- ä¿å­˜æŒ‰é’® -->
                <div class="d-grid gap-2">
                    @if (!string.IsNullOrEmpty(errorMessage))
                    {
                        <div class="alert alert-danger">
                            <strong>âŒ </strong>@errorMessage
                        </div>
                    }
                    <button class="btn btn-success btn-lg" @onclick="SaveRecord">
                        <span class="oi oi-check"></span> @L["Weighing_SaveRecord"]
                    </button>
                    <button class="btn btn-outline-secondary" @onclick="ClearForm">
                        <span class="oi oi-reload"></span> @L["Weighing_Reset"]
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- å³ä¾§/ç§»åŠ¨ç«¯ï¼šç»Ÿè®¡å’Œæœ€è¿‘è®°å½• -->
    <div class="col-12 col-md-4">
        <!-- ç§»åŠ¨ç«¯æŠ˜å å†…å®¹ -->
        <div class="collapse d-md-block" id="mobileStats">
            <!-- ä»Šæ—¥ç»Ÿè®¡ -->
            <div class="card mb-3">
                <div class="card-header bg-info text-white py-2">
                    <h6 class="mb-0">ğŸ“Š @L["Weighing_TodayStats"]</h6>
                </div>
                <div class="card-body py-2">
                    @if (todaySummary != null)
                    {
                        <div class="row text-center">
                            <div class="col-4">
                                <div class="fs-4 fw-bold text-primary">@todaySummary.TotalRecords</div>
                                <small class="text-muted">@L["Weighing_RecordCount"]</small>
                            </div>
                            <div class="col-4">
                                <div class="fs-4 fw-bold text-success">@(todaySummary.TotalWeight.ToString("F1"))</div>
                                <small class="text-muted">@L["Weighing_TotalWeight"]</small>
                            </div>
                            <div class="col-4">
                                <div class="fs-4 fw-bold text-info">@todaySummary.UniqueBarcodes</div>
                                <small class="text-muted">@L["Weighing_BarcodeCount"]</small>
                            </div>
                        </div>
                    }
                    else
                    {
                        <p class="text-muted mb-0 text-center">@L["Status_Loading"]</p>
                    }
                </div>
            </div>

            <!-- æœ€è¿‘è®°å½• -->
            <div class="card">
                <div class="card-header bg-secondary text-white py-2">
                    <h6 class="mb-0">ğŸ“ @L["Weighing_RecentRecords"]</h6>
                </div>
                <div class="card-body p-0" style="max-height: 300px; overflow-y: auto;">
                    @if (recentRecords.Any())
                    {
                        <div class="list-group list-group-flush">
                            @foreach (var record in recentRecords)
                            {
                                <div class="list-group-item py-2 px-3">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <code class="fw-bold">@record.Barcode</code>
                                        </div>
                                        <div class="text-end">
                                            <div class="fw-bold">@record.WeightInPounds.ToString("F2") lb</div>
                                            <small class="text-muted">@record.CreatedAt.ToString("HH:mm")</small>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <p class="text-muted text-center py-3 mb-0">@L["Weighing_NoRecords"]</p>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    // SignalRè¿æ¥ï¼ˆç”¨äºæ‰«ç æªï¼‰
    private HubConnection? hubConnection;

    // è¾“å…¥æ¡†å¼•ç”¨ï¼ˆç”¨äºè‡ªåŠ¨èšç„¦ï¼‰
    private ElementReference barcodeInput;
    private ElementReference weightInput;

    // æ¡ç 
    private string currentBarcode = string.Empty;
    private string parsedCode = string.Empty;  // ä»äºŒç»´ç è§£æå‡ºçš„ç”¨æˆ·ç¼–å·
    private int parsedMeatTypeId = 0;  // ä»äºŒç»´ç è§£æå‡ºçš„è‚‰ç±»ç±»å‹ID
    private string parsedMeatTypeName = string.Empty;  // è‚‰ç±»ç±»å‹åç§°ï¼ˆç”¨äºæ˜¾ç¤ºï¼‰

    // é‡é‡çŠ¶æ€
    private decimal manualWeightInput = 0;  // æ‰‹åŠ¨è¾“å…¥çš„é‡é‡

    // å…¶ä»–å­—æ®µ
    private string? remarks;
    private string? errorMessage;  // é”™è¯¯æç¤º

    // ç»Ÿè®¡æ•°æ®
    private TodaySummary? todaySummary;
    private List<WeighingRecordResponse> recentRecords = new();

    // ä¿å­˜æ¡ä»¶ï¼šæœ‰æ¡ç  + è§£ææˆåŠŸ + é‡é‡å¤§äº0
    private bool CanSave => !string.IsNullOrWhiteSpace(currentBarcode)
        && parsedMeatTypeId > 0
        && !string.IsNullOrWhiteSpace(parsedCode)
        && manualWeightInput > 0;

    protected override async Task OnInitializedAsync()
    {
        var stopwatch = System.Diagnostics.Stopwatch.StartNew();
        Console.WriteLine("=== ç§°é‡é¡µé¢åˆå§‹åŒ–å¼€å§‹ ===");

        // åˆå§‹åŒ–SignalRè¿æ¥å¯¹è±¡ï¼ˆä¸å¯åŠ¨è¿æ¥ï¼Œé¿å…é˜»å¡æ•°æ®åŠ è½½ï¼‰
        hubConnection = new HubConnectionBuilder()
            .WithUrl(Navigation.ToAbsoluteUri("/hardwareHub"))
            .Build();

        // è®¢é˜…æ‰«ç äº‹ä»¶ï¼ˆä¿ç•™ï¼Œæ‰«ç æªè¿˜æ˜¯æœ‰ç”¨çš„ï¼‰
        hubConnection.On<object>("ReceiveBarcode", (data) =>
        {
            var json = System.Text.Json.JsonSerializer.Serialize(data);
            var barcodeData = System.Text.Json.JsonSerializer.Deserialize<BarcodeData>(json);

            if (barcodeData != null && !string.IsNullOrEmpty(barcodeData.barcode))
            {
                currentBarcode = barcodeData.barcode;
                InvokeAsync(StateHasChanged);
            }
        });

        Console.WriteLine($"[{stopwatch.ElapsedMilliseconds}ms] SignalRè¿æ¥å¯¹è±¡åˆ›å»ºå®Œæˆ");

        // æ€§èƒ½ä¼˜åŒ–ï¼šå…ˆåŠ è½½æ•°æ®ï¼ŒSignalRè¿æ¥åœ¨OnAfterRenderAsyncä¸­åå°å¯åŠ¨
        // é¡ºåºåŠ è½½ä»Šæ—¥ç»Ÿè®¡å’Œæœ€è¿‘è®°å½•ï¼ˆé¿å…DbContextå¹¶å‘é”™è¯¯ï¼‰
        await LoadTodaySummary();
        Console.WriteLine($"[{stopwatch.ElapsedMilliseconds}ms] ä»Šæ—¥ç»Ÿè®¡åŠ è½½å®Œæˆ");

        await LoadRecentRecords();
        Console.WriteLine($"[{stopwatch.ElapsedMilliseconds}ms] æœ€è¿‘è®°å½•åŠ è½½å®Œæˆ");

        stopwatch.Stop();
        Console.WriteLine($"=== ç§°é‡é¡µé¢æ•°æ®åŠ è½½å®Œæˆï¼Œæ€»è€—æ—¶: {stopwatch.ElapsedMilliseconds}ms ===");
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // é¡µé¢é¦–æ¬¡åŠ è½½ï¼Œè‡ªåŠ¨èšç„¦åˆ°æ¡ç è¾“å…¥æ¡†
            await FocusBarcodeInput();

            // æ€§èƒ½ä¼˜åŒ–ï¼šåœ¨åå°å¯åŠ¨SignalRè¿æ¥ï¼Œä¸é˜»å¡æ•°æ®æ˜¾ç¤º
            if (hubConnection != null)
            {
                _ = Task.Run(async () =>
                {
                    var stopwatch = System.Diagnostics.Stopwatch.StartNew();
                    Console.WriteLine("=== å¼€å§‹åå°è¿æ¥SignalR ===");

                    try
                    {
                        await hubConnection.StartAsync();
                        Console.WriteLine($"[{stopwatch.ElapsedMilliseconds}ms] SignalRè¿æ¥å¯åŠ¨æˆåŠŸ");
                    }
                    catch (Exception ex)
                    {
                        Console.WriteLine($"[{stopwatch.ElapsedMilliseconds}ms] SignalRè¿æ¥å¤±è´¥: {ex.Message}");
                    }
                });
            }
        }
    }

    private async Task FocusBarcodeInput()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("eval", "document.querySelector('input[placeholder*=\"æ‰«ç \"]')?.focus()");
        }
        catch { /* å¿½ç•¥èšç„¦å¤±è´¥ */ }
    }

    private async Task FocusWeightInput()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("eval", "document.querySelector('input[type=\"number\"]')?.focus()");
        }
        catch { /* å¿½ç•¥èšç„¦å¤±è´¥ */ }
    }

    private async Task LoadTodaySummary()
    {
        todaySummary = await WeighingRecordService.GetTodaySummaryAsync();
    }

    private async Task LoadRecentRecords()
    {
        var query = new WeighingRecordQueryRequest
        {
            PageNumber = 1,
            PageSize = 10
        };

        var (records, _) = await WeighingRecordService.QueryAsync(query);
        recentRecords = records;
    }

    // æ¡ç è¾“å…¥æ¡†å›è½¦ï¼šè§£ææ¡ç å¹¶è·³è½¬åˆ°é‡é‡è¾“å…¥æ¡†
    private async Task OnBarcodeKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !string.IsNullOrWhiteSpace(currentBarcode))
        {
            await ParseBarcode();
            await FocusWeightInput();
        }
    }

    // è§£æäºŒç»´ç å†…å®¹ï¼ˆæ ¼å¼ï¼šPORK-001ï¼‰
    private async Task ParseBarcode()
    {
        try
        {
            var barcode = currentBarcode.Trim();

            // æ£€æŸ¥æ ¼å¼ï¼šå¿…é¡»åŒ…å«"-"åˆ†éš”ç¬¦
            if (!barcode.Contains("-"))
            {
                errorMessage = "äºŒç»´ç æ ¼å¼é”™è¯¯ï¼æ­£ç¡®æ ¼å¼ï¼šPORK-001";
                parsedCode = string.Empty;
                parsedMeatTypeId = 0;
                parsedMeatTypeName = string.Empty;
                return;
            }

            // ã€å…³é”®æ£€æŸ¥ã€‘å…ˆæ£€æŸ¥äºŒç»´ç æ˜¯å¦åœ¨äºŒç»´ç ç®¡ç†ä¸­å­˜åœ¨
            var qrCode = await QRCodeService.GetByContentAsync(barcode);
            if (qrCode == null)
            {
                errorMessage = L["QRCode_NotFound"];
                parsedCode = string.Empty;
                parsedMeatTypeId = 0;
                parsedMeatTypeName = string.Empty;
                return;
            }

            // ã€å…³é”®æ£€æŸ¥ã€‘æ£€æŸ¥äºŒç»´ç æ˜¯å¦æ¿€æ´»
            if (!qrCode.IsActive)
            {
                errorMessage = L["QRCode_Inactive"];
                parsedCode = string.Empty;
                parsedMeatTypeId = 0;
                parsedMeatTypeName = string.Empty;
                return;
            }

            // æ‹†åˆ†äºŒç»´ç ï¼šPORK-001 â†’ ["PORK", "001"]
            var parts = barcode.Split('-', 2);
            var meatTypeCode = parts[0].Trim().ToUpper();
            var code = parts[1].Trim();

            // æ ¹æ®è‚‰ç±»ç±»å‹ä»£ç æŸ¥è¯¢è‚‰ç±»ç±»å‹
            var meatType = await MeatTypeService.GetByCodeAsync(meatTypeCode);
            if (meatType == null)
            {
                errorMessage = $"è‚‰ç±»ç±»å‹ä»£ç  '{meatTypeCode}' ä¸å­˜åœ¨ï¼";
                parsedCode = string.Empty;
                parsedMeatTypeId = 0;
                parsedMeatTypeName = string.Empty;
                return;
            }

            // æ£€æŸ¥è‚‰ç±»ç±»å‹æ˜¯å¦æ¿€æ´»
            if (!meatType.IsActive)
            {
                errorMessage = $"è‚‰ç±»ç±»å‹ '{meatType.Name}' å·²åœç”¨ï¼";
                parsedCode = string.Empty;
                parsedMeatTypeId = 0;
                parsedMeatTypeName = string.Empty;
                return;
            }

            // è§£ææˆåŠŸ
            parsedCode = code;
            parsedMeatTypeId = meatType.Id;
            parsedMeatTypeName = meatType.Name;
            errorMessage = null;
        }
        catch (Exception ex)
        {
            errorMessage = $"è§£æäºŒç»´ç å¤±è´¥ï¼š{ex.Message}";
            parsedCode = string.Empty;
            parsedMeatTypeId = 0;
            parsedMeatTypeName = string.Empty;
        }
    }

    // é‡é‡è¾“å…¥æ¡†å›è½¦ï¼šç›´æ¥ä¿å­˜
    private async Task OnWeightKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && manualWeightInput > 0)
        {
            await SaveRecord();
        }
    }

    private async Task SaveRecord()
    {
        errorMessage = null;

        // éªŒè¯æ¡ç 
        if (string.IsNullOrWhiteSpace(currentBarcode))
        {
            errorMessage = L["Weighing_ErrorBarcodeRequired"];
            return;
        }

        // éªŒè¯é‡é‡
        if (manualWeightInput <= 0)
        {
            errorMessage = L["Weighing_ErrorWeightRequired"];
            return;
        }

        // éªŒè¯äºŒç»´ç è§£æç»“æœ
        if (parsedMeatTypeId == 0 || string.IsNullOrWhiteSpace(parsedCode))
        {
            errorMessage = "è¯·å…ˆè¾“å…¥æœ‰æ•ˆçš„äºŒç»´ç å¹¶æŒ‰å›è½¦è§£æï¼";
            return;
        }

        try
        {
            // è·å–å½“å‰ç™»å½•ç”¨æˆ·
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var currentUser = authState.User.Identity?.Name ?? "Unknown";

            var request = new CreateWeighingRecordRequest
            {
                Barcode = currentBarcode.Trim(),
                Code = parsedCode,
                MeatTypeId = parsedMeatTypeId,
                Weight = manualWeightInput,
                Remarks = remarks
            };

            await WeighingRecordService.CreateAsync(request, currentUser);

            await LoadTodaySummary();
            await LoadRecentRecords();

            // æ¸…ç©ºï¼Œå‡†å¤‡ä¸‹ä¸€æ¬¡
            currentBarcode = string.Empty;
            parsedCode = string.Empty;
            parsedMeatTypeId = 0;
            parsedMeatTypeName = string.Empty;
            manualWeightInput = 0;
            remarks = null;

            StateHasChanged();

            // ä¿å­˜æˆåŠŸåè‡ªåŠ¨èšç„¦å›æ¡ç è¾“å…¥æ¡†ï¼Œå‡†å¤‡ä¸‹ä¸€æ¬¡æ‰«ç 
            await FocusBarcodeInput();
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
            StateHasChanged();
        }
    }

    private void ClearForm()
    {
        currentBarcode = string.Empty;
        parsedCode = string.Empty;
        parsedMeatTypeId = 0;
        parsedMeatTypeName = string.Empty;
        manualWeightInput = 0;
        remarks = null;
        errorMessage = null;
        StateHasChanged();
    }

    public async ValueTask DisposeAsync()
    {
        if (hubConnection != null)
        {
            await hubConnection.DisposeAsync();
        }
    }

    private class BarcodeData
    {
        public string barcode { get; set; } = string.Empty;
    }
}
