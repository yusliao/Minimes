@page "/qrcodes/print/{id:int}"
@attribute [Microsoft.AspNetCore.Authorization.Authorize(Policy = "Admin")]
@using Minimes.Application.Interfaces
@using Minimes.Application.DTOs.QRCode
@inject IQRCodeService QRCodeService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime

<PageTitle>打印二维码 - MiniMES</PageTitle>

<style>
    /* 屏幕显示样式 */
    .print-preview {
        background: #f5f5f5;
        padding: 20px;
        min-height: 100vh;
    }

    .print-container {
        background: white;
        margin: 0 auto;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }

    /* 标签打印样式 (80mm x 50mm) */
    .label-print {
        width: 80mm;
        height: 50mm;
        padding: 5mm;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }

    .label-print .qr-image {
        width: 35mm;
        height: 35mm;
        margin-bottom: 2mm;
    }

    .label-print .qr-info {
        text-align: center;
        font-size: 10pt;
        font-weight: bold;
    }

    /* A4打印样式 */
    .a4-print {
        width: 210mm;
        min-height: 297mm;
        padding: 10mm;
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        grid-gap: 5mm;
    }

    .a4-print .qr-item {
        border: 1px solid #ddd;
        padding: 5mm;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }

    .a4-print .qr-image {
        width: 50mm;
        height: 50mm;
        margin-bottom: 2mm;
    }

    .a4-print .qr-info {
        text-align: center;
        font-size: 9pt;
        font-weight: bold;
    }

    /* 打印时的样式 */
    @@media print {
        body {
            margin: 0;
            padding: 0;
        }

        .print-preview {
            background: white;
            padding: 0;
        }

        .print-container {
            box-shadow: none;
            margin: 0;
        }

        .no-print {
            display: none !important;
        }

        .label-print {
            page-break-after: always;
        }

        .a4-print {
            page-break-after: always;
        }
    }
</style>

<div class="print-preview">
    <!-- 工具栏（不打印） -->
    <div class="no-print mb-3">
        <div class="container-fluid">
            <div class="row">
                <div class="col">
                    <h4>
                        <span class="oi oi-print me-2"></span>打印预览
                    </h4>
                </div>
                <div class="col-auto">
                    <div class="btn-group me-2">
                        <button class="btn btn-sm @(printMode == "label" ? "btn-primary" : "btn-outline-primary")"
                                @onclick='() => SetPrintMode("label")'>
                            <span class="oi oi-tag me-1"></span>标签打印
                        </button>
                        <button class="btn btn-sm @(printMode == "a4" ? "btn-primary" : "btn-outline-primary")"
                                @onclick='() => SetPrintMode("a4")'>
                            <span class="oi oi-document me-1"></span>A4打印
                        </button>
                    </div>
                    <button class="btn btn-sm btn-success me-2" @onclick="ExecutePrint">
                        <span class="oi oi-print me-1"></span>打印
                    </button>
                    <button class="btn btn-sm btn-secondary" @onclick="Close">
                        <span class="oi oi-x me-1"></span>关闭
                    </button>
                </div>
            </div>
        </div>
    </div>

    @if (isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">加载中...</span>
            </div>
            <p class="text-muted mt-2">加载数据中...</p>
        </div>
    }
    else if (qrCode == null)
    {
        <div class="alert alert-warning no-print">
            <span class="oi oi-warning me-2"></span>未找到指定的二维码记录
        </div>
    }
    else
    {
        <!-- 标签打印模式 -->
        @if (printMode == "label")
        {
            <div class="print-container label-print">
                @if (!string.IsNullOrEmpty(qrCode.ImageBase64))
                {
                    <img src="data:image/png;base64,@qrCode.ImageBase64"
                         alt="QR Code"
                         class="qr-image" />
                }
                <div class="qr-info">
                    <div>@qrCode.MeatTypeName</div>
                    <div>@qrCode.Content</div>
                </div>
            </div>
        }

        <!-- A4打印模式 -->
        @if (printMode == "a4")
        {
            <div class="print-container a4-print">
                @for (int i = 0; i < 9; i++)
                {
                    <div class="qr-item">
                        @if (!string.IsNullOrEmpty(qrCode.ImageBase64))
                        {
                            <img src="data:image/png;base64,@qrCode.ImageBase64"
                                 alt="QR Code"
                                 class="qr-image" />
                        }
                        <div class="qr-info">
                            <div>@qrCode.MeatTypeName</div>
                            <div>@qrCode.Content</div>
                        </div>
                    </div>
                }
            </div>
        }
    }
</div>

@code {
    [Parameter]
    public int Id { get; set; }

    private QRCodeResponse? qrCode;
    private bool isLoading = true;
    private string printMode = "label"; // "label" 或 "a4"

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        isLoading = true;
        try
        {
            qrCode = await QRCodeService.GetByIdAsync(Id);
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"加载数据失败: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private void SetPrintMode(string mode)
    {
        printMode = mode;
    }

    private async Task ExecutePrint()
    {
        try
        {
            // 记录打印次数
            await QRCodeService.RecordPrintAsync(Id);

            // 调用浏览器打印
            await JSRuntime.InvokeVoidAsync("window.print");
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"打印失败: {ex.Message}");
        }
    }

    private void Close()
    {
        Navigation.NavigateTo("/qrcodes");
    }
}
