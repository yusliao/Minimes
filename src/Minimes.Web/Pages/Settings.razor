@page "/settings"
@using Microsoft.Extensions.Configuration
@using Microsoft.Extensions.Localization
@using Microsoft.Extensions.Options
@using Microsoft.EntityFrameworkCore
@using Minimes.Application.Configuration
@using Minimes.Infrastructure.Persistence
@using Minimes.Application.Resources
@using System.Text.Json
@inject IStringLocalizer<SharedResource> L
@inject IConfiguration Configuration
@inject IOptions<WeightValidationConfig> WeightConfig
@inject IWebHostEnvironment Environment
@inject NavigationManager Navigation
@inject ApplicationDbContext DbContext
@inject IJSRuntime JSRuntime
@attribute [Microsoft.AspNetCore.Authorization.Authorize(Policy = "Admin")]
@implements IDisposable

<PageTitle>@L["Settings_Title"] - MiniMES</PageTitle>

<div class="container-fluid">
    <div class="row mb-4">
        <div class="col">
            <h2>
                <span class="oi oi-cog me-2"></span>@L["Settings_Title"]
            </h2>
            <p class="text-muted">@L["Settings_Subtitle"]</p>
        </div>
    </div>

    <!-- 应用信息 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <span class="oi oi-info me-2"></span>@L["Settings_AppInfo"]
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-6 col-md-3 mb-3">
                            <div class="text-muted small">@L["Settings_AppName"]</div>
                            <div><strong>MiniMES</strong></div>
                        </div>
                        <div class="col-6 col-md-3 mb-3">
                            <div class="text-muted small">@L["Settings_Version"]</div>
                            <div><strong>v1.0.0</strong></div>
                        </div>
                        <div class="col-6 col-md-3 mb-3">
                            <div class="text-muted small">@L["Settings_Framework"]</div>
                            <div><strong>.NET 8.0 Blazor</strong></div>
                        </div>
                        <div class="col-6 col-md-3 mb-3">
                            <div class="text-muted small">@L["Settings_Database"]</div>
                            <div><strong>SQLite</strong></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 系统状态 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <span class="oi oi-dashboard me-2"></span>@L["Settings_SystemStatus"]
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6 col-md-3 mb-3">
                            <div class="border rounded p-3">
                                <div class="text-muted small">@L["Settings_StartTime"]</div>
                                <div class="fw-bold">@startTime.ToString("MM-dd HH:mm")</div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3 mb-3">
                            <div class="border rounded p-3">
                                <div class="text-muted small">@L["Settings_Uptime"]</div>
                                <div class="fw-bold">@GetUptime()</div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3 mb-3">
                            <div class="border rounded p-3">
                                <div class="text-muted small">@L["Settings_DbSize"]</div>
                                <div class="fw-bold">@dbSize</div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3 mb-3">
                            <div class="border rounded p-3">
                                <div class="text-muted small">@L["Settings_RecordCount"]</div>
                                <div class="fw-bold">@recordCount @L["Tracing_Records"]</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <!-- 电子秤设置 -->
        <div class="col-12 col-lg-6 mb-4">
            <div class="card h-100">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <span class="oi oi-monitor me-2"></span>@L["Settings_ScaleSettings"]
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-2">
                        <span class="text-muted">@L["Settings_PortName"]:</span>
                        <code class="ms-2">@scalePortName</code>
                    </div>
                    <div class="mb-2">
                        <span class="text-muted">@L["Settings_BaudRate"]:</span>
                        <code class="ms-2">@scaleBaudRate</code>
                    </div>
                    <div class="mb-3">
                        <span class="text-muted">@L["Settings_Protocol"]:</span>
                        <code class="ms-2">@scaleProtocol</code>
                    </div>
                    <div class="alert alert-info mb-0 small">
                        <span class="oi oi-info me-1"></span>
                        @L["Settings_HardwareNote"]
                    </div>
                </div>
            </div>
        </div>

        <!-- 数据库管理 -->
        <div class="col-12 col-lg-6 mb-4">
            <div class="card h-100">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">
                        <span class="oi oi-database me-2"></span>@L["Settings_DbManagement"]
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-2">
                        <span class="text-muted">@L["Settings_DbFile"]:</span>
                        <code class="ms-2">minimes.db</code>
                    </div>
                    <div class="mb-3">
                        <span class="text-muted">@L["Settings_FileSize"]:</span>
                        <code class="ms-2">@dbSize</code>
                    </div>
                    <hr />
                    <div class="d-grid">
                        <button class="btn btn-outline-primary btn-lg" @onclick="BackupDatabase" disabled="@isBackingUp">
                            @if (isBackingUp)
                            {
                                <span class="spinner-border spinner-border-sm me-1"></span>
                            }
                            else
                            {
                                <span class="oi oi-data-transfer-download me-1"></span>
                            }
                            @L["Settings_BackupDb"]
                        </button>
                    </div>
                    @if (!string.IsNullOrEmpty(backupMessage))
                    {
                        <div class="alert @(backupSuccess ? "alert-success" : "alert-danger") mt-3 mb-0 small">
                            @backupMessage
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- 称重配置 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <span class="oi oi-balance-scale me-2"></span>@L["Settings_WeightConfig"]
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-12 col-md-6 mb-3">
                            <label class="form-label fw-bold">@L["Settings_MinWeightLb"]</label>
                            <div class="input-group">
                                <input type="number" class="form-control" @bind="minWeightLb" step="0.001" min="0" />
                                <span class="input-group-text">lb</span>
                            </div>
                            <small class="text-muted">@L["Settings_CurrentConfig"] @currentMinWeightLb.ToString("F3") lb</small>
                        </div>
                        <div class="col-12 col-md-6 mb-3">
                            <label class="form-label fw-bold">@L["Settings_MaxWeightLb"]</label>
                            <div class="input-group">
                                <input type="number" class="form-control" @bind="maxWeightLb" step="0.1" min="0" />
                                <span class="input-group-text">lb</span>
                            </div>
                            <small class="text-muted">@L["Settings_CurrentConfig"] @currentMaxWeightLb.ToString("F1") lb</small>
                        </div>
                    </div>
                    <hr />
                    <div class="d-grid gap-2 d-md-flex">
                        <button class="btn btn-primary" @onclick="SaveWeightConfig" disabled="@isSavingConfig">
                            @if (isSavingConfig)
                            {
                                <span class="spinner-border spinner-border-sm me-1"></span>
                            }
                            else
                            {
                                <span class="oi oi-check me-1"></span>
                            }
                            @L["Settings_SaveConfig"]
                        </button>
                        <button class="btn btn-outline-secondary" @onclick="ResetWeightConfig">
                            <span class="oi oi-reload me-1"></span>@L["Btn_Reset"]
                        </button>
                    </div>
                    @if (!string.IsNullOrEmpty(configMessage))
                    {
                        <div class="alert @(configSuccess ? "alert-success" : "alert-danger") mt-3 mb-0">
                            @configMessage
                        </div>
                    }
                    <div class="alert alert-success mt-3 mb-0 small">
                        <span class="oi oi-check me-1"></span>
                        <strong>@L["Settings_ConfigTip"]</strong>@L["Settings_ConfigHint"]
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 快捷入口 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">
                        <span class="oi oi-link-intact me-2"></span>@L["Settings_QuickLinks"]
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-6 col-md-4 col-lg-3 mb-3">
                            <div class="d-grid">
                                <button class="btn btn-primary" @onclick="GoToUsers">
                                    <span class="oi oi-people me-1"></span>@L["User_Title"]
                                </button>
                            </div>
                        </div>
                        <div class="col-6 col-md-4 col-lg-3 mb-3">
                            <div class="d-grid">
                                <button class="btn btn-success" @onclick="GoToHardwareTest">
                                    <span class="oi oi-wrench me-1"></span>@L["Nav_HardwareTest"]
                                </button>
                            </div>
                        </div>
                        <div class="col-6 col-md-4 col-lg-3 mb-3">
                            <div class="d-grid">
                                <button class="btn btn-warning" @onclick="GoToProduction">
                                    <span class="oi oi-graph me-1"></span>@L["Report_Title"]
                                </button>
                            </div>
                        </div>
                        <div class="col-6 col-md-4 col-lg-3 mb-3">
                            <div class="d-grid">
                                <button class="btn btn-info" @onclick="GoToTracing">
                                    <span class="oi oi-magnifying-glass me-1"></span>@L["Tracing_Title"]
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 技术栈 -->
    <div class="row">
        <div class="col-12">
            <div class="card bg-light">
                <div class="card-body">
                    <h6 class="card-title mb-3">
                        <span class="oi oi-code me-2"></span>@L["Settings_TechStack"]
                    </h6>
                    <div class="row small">
                        <div class="col-4 col-md-2 mb-2">
                            <span class="text-muted">@L["Settings_Framework"]</span><br /><strong>.NET 8.0</strong>
                        </div>
                        <div class="col-4 col-md-2 mb-2">
                            <span class="text-muted">@L["Settings_Web"]</span><br /><strong>Blazor Server</strong>
                        </div>
                        <div class="col-4 col-md-2 mb-2">
                            <span class="text-muted">@L["Settings_ORM"]</span><br /><strong>EF Core 8.0</strong>
                        </div>
                        <div class="col-4 col-md-2 mb-2">
                            <span class="text-muted">@L["Settings_Validation"]</span><br /><strong>FluentValidation</strong>
                        </div>
                        <div class="col-4 col-md-2 mb-2">
                            <span class="text-muted">@L["Settings_Excel"]</span><br /><strong>EPPlus 8.4</strong>
                        </div>
                        <div class="col-4 col-md-2 mb-2">
                            <span class="text-muted">@L["Settings_Realtime"]</span><br /><strong>SignalR</strong>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private string scalePortName = string.Empty;
    private int scaleBaudRate = 0;
    private string scaleProtocol = string.Empty;
    private string dbSize = string.Empty;
    private int recordCount = 0;
    private static DateTime startTime = DateTime.Now;

    private bool isBackingUp = false;
    private string? backupMessage;
    private bool backupSuccess = false;

    // 称重配置相关变量
    private decimal minWeightLb = 0;
    private decimal maxWeightLb = 0;
    private decimal currentMinWeightLb = 0;
    private decimal currentMaxWeightLb = 0;
    private bool isSavingConfig = false;
    private string? configMessage;
    private bool configSuccess = false;

    private CancellationTokenSource? cancellationTokenSource;

    protected override async Task OnInitializedAsync()
    {
        LoadSettings();
        LoadWeightConfig();
        await LoadStatistics();

        // 启动定时刷新运行时长
        cancellationTokenSource = new CancellationTokenSource();
        _ = UpdateUptimeLoop(cancellationTokenSource.Token);
    }

    private async Task UpdateUptimeLoop(CancellationToken cancellationToken)
    {
        try
        {
            while (!cancellationToken.IsCancellationRequested)
            {
                await Task.Delay(5000, cancellationToken); // 每5秒更新一次
                await InvokeAsync(StateHasChanged);
            }
        }
        catch (TaskCanceledException)
        {
            // 正常取消，忽略
        }
    }

    public void Dispose()
    {
        cancellationTokenSource?.Cancel();
        cancellationTokenSource?.Dispose();
    }

    private void LoadSettings()
    {
        scalePortName = Configuration["Scale:PortName"] ?? L["Settings_NotConfigured"].Value;
        scaleBaudRate = Configuration.GetValue<int>("Scale:BaudRate", 9600);
        scaleProtocol = Configuration["Scale:Protocol"] ?? "Generic";
    }

    private async Task LoadStatistics()
    {
        try
        {
            // 获取记录数
            recordCount = await DbContext.WeighingRecords.CountAsync();

            // 获取数据库文件大小
            var connStr = Configuration.GetConnectionString("DefaultConnection") ?? "";
            var dbPath = connStr.Replace("Data Source=", "").Trim();
            if (File.Exists(dbPath))
            {
                var fileInfo = new FileInfo(dbPath);
                var sizeKb = fileInfo.Length / 1024.0;
                dbSize = sizeKb < 1024 ? $"{sizeKb:F1} KB" : $"{sizeKb / 1024:F2} MB";
            }
            else
            {
                dbSize = L["Settings_NotFound"].Value;
            }
        }
        catch
        {
            dbSize = L["Settings_Unknown"].Value;
        }
    }

    private string GetUptime()
    {
        var uptime = DateTime.Now - startTime;
        if (uptime.TotalHours < 1)
            return $"{(int)uptime.TotalMinutes} {L["Settings_Minutes"].Value}";
        if (uptime.TotalDays < 1)
            return $"{(int)uptime.TotalHours} {L["Settings_Hours"].Value} {uptime.Minutes} {L["Settings_Min"].Value}";
        return $"{(int)uptime.TotalDays} {L["Settings_Days"].Value} {uptime.Hours} {L["Settings_Hours"].Value}";
    }

    private void LoadWeightConfig()
    {
        // 从配置中读取千克值，转换为磅显示
        var config = WeightConfig.Value;
        currentMinWeightLb = config.MinWeightKg / 0.45359237m;
        currentMaxWeightLb = config.MaxWeightKg / 0.45359237m;

        // 初始化输入框值
        minWeightLb = currentMinWeightLb;
        maxWeightLb = currentMaxWeightLb;
    }

    private void ResetWeightConfig()
    {
        minWeightLb = currentMinWeightLb;
        maxWeightLb = currentMaxWeightLb;
        configMessage = null;
    }

    private async Task SaveWeightConfig()
    {
        isSavingConfig = true;
        configMessage = null;

        try
        {
            // 验证输入
            if (minWeightLb <= 0 || maxWeightLb <= 0)
            {
                configMessage = L["Settings_WeightMustPositive"].Value;
                configSuccess = false;
                return;
            }

            if (minWeightLb >= maxWeightLb)
            {
                configMessage = L["Settings_MinLessThanMax"].Value;
                configSuccess = false;
                return;
            }

            // 转换为千克
            var minWeightKg = minWeightLb * 0.45359237m;
            var maxWeightKg = maxWeightLb * 0.45359237m;

            // 读取appsettings.json文件（使用项目根目录）
            var appSettingsPath = Path.Combine(Environment.ContentRootPath, "appsettings.json");
            if (!File.Exists(appSettingsPath))
            {
                configMessage = $"{L["Settings_ConfigFileNotExist"].Value} {appSettingsPath}";
                configSuccess = false;
                return;
            }

            var jsonText = await File.ReadAllTextAsync(appSettingsPath);
            var jsonDoc = JsonDocument.Parse(jsonText);
            var root = jsonDoc.RootElement;

            // 构建新的JSON对象
            using var stream = new MemoryStream();
            using (var writer = new Utf8JsonWriter(stream, new JsonWriterOptions { Indented = true }))
            {
                writer.WriteStartObject();

                foreach (var property in root.EnumerateObject())
                {
                    if (property.Name == "WeightValidation")
                    {
                        // 写入新的WeightValidation配置
                        writer.WriteStartObject("WeightValidation");
                        writer.WriteNumber("MinWeightKg", minWeightKg);
                        writer.WriteNumber("MaxWeightKg", maxWeightKg);
                        writer.WriteEndObject();
                    }
                    else
                    {
                        // 保持其他配置不变
                        property.WriteTo(writer);
                    }
                }

                writer.WriteEndObject();
            }

            // 写回文件
            var newJsonText = System.Text.Encoding.UTF8.GetString(stream.ToArray());
            await File.WriteAllTextAsync(appSettingsPath, newJsonText);

            // 更新当前配置显示
            currentMinWeightLb = minWeightLb;
            currentMaxWeightLb = maxWeightLb;

            configMessage = $"{L["Settings_ConfigSaveSuccess"].Value} {L["Settings_MinWeightLb"].Value} {minWeightLb:F3} lb, {L["Settings_MaxWeightLb"].Value} {maxWeightLb:F1} lb";
            configSuccess = true;
        }
        catch (Exception ex)
        {
            configMessage = $"{L["Settings_SaveFailed"].Value} {ex.Message}";
            configSuccess = false;
        }
        finally
        {
            isSavingConfig = false;
        }
    }

    private async Task BackupDatabase()
    {
        isBackingUp = true;
        backupMessage = null;

        try
        {
            var connStr = Configuration.GetConnectionString("DefaultConnection") ?? "";
            var dbPath = connStr.Replace("Data Source=", "").Trim();

            if (!File.Exists(dbPath))
            {
                backupMessage = L["Settings_DbNotExist"].Value;
                backupSuccess = false;
                return;
            }

            var bytes = await File.ReadAllBytesAsync(dbPath);
            var base64 = Convert.ToBase64String(bytes);
            var fileName = $"minimes_backup_{DateTime.Now:yyyyMMdd_HHmmss}.db";

            await JSRuntime.InvokeVoidAsync("downloadFile", fileName, base64);

            backupMessage = $"{L["Settings_BackupSuccess"].Value}: {fileName}";
            backupSuccess = true;
        }
        catch (Exception ex)
        {
            backupMessage = $"{L["Settings_BackupFailed"].Value}: {ex.Message}";
            backupSuccess = false;
        }
        finally
        {
            isBackingUp = false;
        }
    }

    private void GoToUsers() => Navigation.NavigateTo("/users");
    private void GoToHardwareTest() => Navigation.NavigateTo("/hardware-test");
    private void GoToProduction() => Navigation.NavigateTo("/reports/production");
    private void GoToTracing() => Navigation.NavigateTo("/reports/tracing");
}
