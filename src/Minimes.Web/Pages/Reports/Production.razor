@page "/reports/production"
@attribute [Microsoft.AspNetCore.Authorization.Authorize(Policy = "Admin")]
@using Microsoft.Extensions.Localization
@using Minimes.Application.Interfaces
@using Minimes.Application.DTOs.WeighingRecord
@using Minimes.Application.DTOs.Report
@using Minimes.Domain.Enums
@using Minimes.Application.Resources
@inject IStringLocalizer<SharedResource> L
@inject IWeighingRecordService WeighingRecordService
@inject IReportService ReportService
@inject IExcelExportService ExcelExportService
@inject IJSRuntime JSRuntime

<PageTitle>@L["Report_Title"] - MiniMES</PageTitle>

<div class="container-fluid">
    <div class="row mb-4">
        <div class="col">
            <h2>
                <span class="oi oi-graph me-2"></span>@L["Report_Title"]
            </h2>
            <p class="text-muted">@L["Report_Subtitle"]</p>
        </div>
    </div>

    <!-- 日期和过滤器 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-light">
                <div class="card-body">
                    <div class="row g-3 align-items-end">
                        <div class="col-12 col-md-6 col-lg-3">
                            <label class="form-label"><strong>@L["Report_Period"]</strong></label>
                            <select class="form-select form-select-lg" @onchange="HandlePeriodChange">
                                <option value="today">@L["Report_Today"]</option>
                                <option value="week">@L["Report_Week"]</option>
                                <option value="month" selected>@L["Report_Month"]</option>
                                <option value="custom">@L["Report_Custom"]</option>
                            </select>
                        </div>

                        @if (selectedPeriod == "custom")
                        {
                            <div class="col-12 col-sm-6 col-md-4 col-lg-2">
                                <label class="form-label"><strong>@L["Report_StartDate"]</strong></label>
                                <input type="date" class="form-control form-control-lg" @bind="startDate" />
                            </div>
                            <div class="col-12 col-sm-6 col-md-4 col-lg-2">
                                <label class="form-label"><strong>@L["Report_EndDate"]</strong></label>
                                <input type="date" class="form-control form-control-lg" @bind="endDate" />
                            </div>
                        }

                        <div class="col-12 col-sm-6 col-md-4 col-lg-2">
                            <button class="btn btn-primary btn-lg w-100" @onclick="LoadReport" disabled="@isLoading">
                                <span class="oi oi-reload me-1"></span>@L["Report_Refresh"]
                            </button>
                        </div>
                        <div class="col-12 col-sm-6 col-md-4 col-lg-2">
                            <button class="btn btn-success btn-lg w-100" @onclick="ExportToExcel" disabled="@(isLoading || records == null || !records.Any())">
                                <span class="oi oi-data-transfer-download me-1"></span>@L["Report_ExportExcel"]
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    @if (isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">@L["Status_Loading"]</span>
            </div>
            <p class="mt-2 text-muted">@L["Report_Generating"]</p>
        </div>
    }
    else if (records == null || !records.Any())
    {
        <div class="alert alert-info text-center py-5">
            <span class="oi oi-info me-2"></span>
            @L["Report_NoData"]
        </div>
    }
    else
    {
        <!-- 统计汇总卡片 -->
        <div class="row mb-4 g-3">
            <div class="col-12 col-sm-6 col-lg-4">
                <div class="card border-primary h-100">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div>
                                <h6 class="card-subtitle mb-2 text-muted">@L["Report_TotalRecords"]</h6>
                                <h2 class="card-title mb-0">@records.Count()</h2>
                            </div>
                            <div class="ms-auto">
                                <span class="oi oi-list" style="font-size: 2.5rem; color: #0d6efd;"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-6 col-lg-4">
                <div class="card border-success h-100">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div>
                                <h6 class="card-subtitle mb-2 text-muted">@L["Report_TotalWeight"]</h6>
                                <h2 class="card-title mb-0">@($"{GetTotalWeight():F2}") <small>lb</small></h2>
                            </div>
                            <div class="ms-auto">
                                <span class="oi oi-scale" style="font-size: 2.5rem; color: #198754;"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-6 col-lg-4">
                <div class="card border-warning h-100">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div>
                                <h6 class="card-subtitle mb-2 text-muted">@L["Report_AverageWeight"]</h6>
                                <h2 class="card-title mb-0">@($"{GetAverageWeight():F2}") <small>lb</small></h2>
                            </div>
                            <div class="ms-auto">
                                <span class="oi oi-bar-chart" style="font-size: 2.5rem; color: #ffc107;"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 日期趋势图 -->
        @if (selectedPeriod != "today")
        {
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header bg-info text-white">
                            <h6 class="mb-0">
                                <span class="oi oi-graph me-2"></span>@L["Report_DateTrendChart"]
                            </h6>
                        </div>
                        <div class="card-body">
                            <canvas id="dateTrendChart" style="height: 350px;"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        }

        <!-- 肉类类型分布 -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-warning text-dark">
                        <h6 class="mb-0">
                            <span class="oi oi-list-rich me-2"></span>@L["Report_MeatTypeChart"]
                        </h6>
                    </div>
                    <div class="card-body">
                        <canvas id="meatTypeChart" style="height: 300px;"></canvas>
                    </div>
                </div>
            </div>
        </div>

        @* 批次维度统计暂时隐藏，目前还没有批次业务
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">
                            <span class="oi oi-list-rich me-2"></span>批次维度统计
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>批次ID</th>
                                        <th>记录数</th>
                                        <th>总重量 (lb)</th>
                                        <th>平均单次 (lb)</th>
                                        <th>原料入库</th>
                                        <th>加工过程</th>
                                        <th>成品出库</th>
                                        <th>损耗率</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var batch in GetBatchStatistics())
                                    {
                                        var receivingWeight = batch.Stages.FirstOrDefault(s => s.Stage == ProcessStage.Receiving)?.TotalWeight ?? 0;
                                        var shippingWeight = batch.Stages.FirstOrDefault(s => s.Stage == ProcessStage.Shipping)?.TotalWeight ?? 0;
                                        var lossRate = receivingWeight > 0 ? ((receivingWeight - shippingWeight) / receivingWeight * 100) : 0;

                                        <tr>
                                            <td><code>@batch.BatchId</code></td>
                                            <td>@batch.RecordCount</td>
                                            <td>@batch.TotalWeight.ToString("F2")</td>
                                            <td>@batch.AverageWeight.ToString("F2")</td>
                                            <td>@receivingWeight.ToString("F2")</td>
                                            <td>@(batch.Stages.FirstOrDefault(s => s.Stage == ProcessStage.Processing)?.TotalWeight.ToString("F2") ?? "0.00")</td>
                                            <td>@shippingWeight.ToString("F2")</td>
                                            <td>
                                                @if (lossRate > 0)
                                                {
                                                    <span class="badge bg-warning">@lossRate.ToString("F1")%</span>
                                                }
                                                else
                                                {
                                                    <span class="badge bg-secondary">0%</span>
                                                }
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        *@
    }
</div>

@code {
    private List<WeighingRecordResponse>? records;
    private ProductionReportResponse? reportSummary;
    private string selectedPeriod = "month";
    private DateTime startDate = DateTime.Today.AddDays(-30);
    private DateTime endDate = DateTime.Today;
    private bool isLoading = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadReport();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        // 每次数据加载后初始化图表
        if (records != null && records.Any())
        {
            await Task.Delay(100); // 等待DOM更新
            await InitializeCharts();
        }
    }

    private async Task LoadReport()
    {
        isLoading = true;
        try
        {
            // 计算日期范围
            var (start, end) = GetDateRange();

            // 加载称重记录列表
            var query = new WeighingRecordQueryRequest
            {
                StartDate = start,
                EndDate = end,
                PageNumber = 1,
                PageSize = 10000
            };

            var (recordsList, _) = await WeighingRecordService.QueryAsync(query);
            records = recordsList;

            // 加载生产报表统计
            var reportRequest = new ProductionReportRequest
            {
                StartDate = start,
                EndDate = end
            };
            reportSummary = await ReportService.GetProductionReportAsync(reportRequest);
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task InitializeCharts()
    {
        if (records == null || !records.Any())
            return;

        try
        {
            // 初始化肉类类型分布图
            await InitializeMeatTypeChart();
            // 如果不是今日报表，初始化日期趋势图
            if (selectedPeriod != "today")
            {
                await InitializeDateTrendChart();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"图表初始化失败: {ex.Message}");
        }
    }

    private async Task InitializeMeatTypeChart()
    {
        if (records == null || !records.Any())
            return;

        // 按肉类类型分组统计
        var meatTypeGroups = records
            .GroupBy(r => r.MeatTypeName)
            .OrderByDescending(g => g.Count())
            .Select(g => new { Type = g.Key, Count = g.Count(), Weight = g.Sum(x => x.Weight) })
            .ToList();

        if (!meatTypeGroups.Any())
            return;

        var labels = meatTypeGroups.Select(m => m.Type).ToList();
        var countData = meatTypeGroups.Select(m => m.Count).ToList();
        var weightData = meatTypeGroups.Select(m => m.Weight).ToList();

        var datasets = new object[]
        {
            new
            {
                label = L["Chart_RecordCount"].Value,
                data = countData,
                backgroundColor = "#36A2EB",
                borderColor = "#36A2EB",
                borderWidth = 2,
                yAxisID = "y"
            },
            new
            {
                label = L["Chart_TotalWeight"].Value,
                data = weightData,
                backgroundColor = "#FF6384",
                borderColor = "#FF6384",
                borderWidth = 2,
                yAxisID = "y1"
            }
        };

        var options = new
        {
            responsive = true,
            maintainAspectRatio = false,
            interaction = new { mode = "index", intersect = false },
            plugins = new { legend = new { display = true, position = "top" } },
            scales = new
            {
                y = new { type = "linear", display = true, position = "left", title = new { display = true, text = L["Chart_RecordCount"].Value } },
                y1 = new { type = "linear", display = true, position = "right", title = new { display = true, text = L["Chart_WeightAxis"].Value }, grid = new { drawOnChartArea = false } }
            }
        };

        await JSRuntime.InvokeVoidAsync("initBarChart", "meatTypeChart", labels, datasets, options);
    }

    private async Task InitializeDateTrendChart()
    {
        if (records == null || !records.Any())
            return;

        // 按日期分组统计
        var dateGroups = records
            .GroupBy(r => r.CreatedAt.Date)
            .OrderBy(g => g.Key)
            .Select(g => new
            {
                Date = g.Key,
                Count = g.Count(),
                Weight = g.Sum(r => r.Weight)
            })
            .ToList();

        if (!dateGroups.Any())
            return;

        var labels = dateGroups.Select(d => d.Date.ToString("MM-dd")).ToList();
        var countData = dateGroups.Select(d => d.Count).ToList();
        var weightData = dateGroups.Select(d => d.Weight).ToList();

        var datasets = new object[]
        {
            new
            {
                label = L["Chart_RecordCount"].Value,
                data = countData,
                borderColor = "#36A2EB",
                backgroundColor = "rgba(54, 162, 235, 0.1)",
                borderWidth = 2,
                fill = true,
                yAxisID = "y"
            },
            new
            {
                label = L["Chart_TotalWeight"].Value,
                data = weightData,
                borderColor = "#FF6384",
                backgroundColor = "rgba(255, 99, 132, 0.1)",
                borderWidth = 2,
                fill = true,
                yAxisID = "y1"
            }
        };

        var options = new
        {
            responsive = true,
            maintainAspectRatio = false,
            interaction = new { mode = "index", intersect = false },
            plugins = new { legend = new { display = true, position = "top" } },
            scales = new
            {
                y = new { type = "linear", display = true, position = "left", title = new { display = true, text = L["Chart_RecordCount"].Value }, beginAtZero = true },
                y1 = new { type = "linear", display = true, position = "right", title = new { display = true, text = L["Chart_WeightAxis"].Value }, grid = new { drawOnChartArea = false }, beginAtZero = true }
            }
        };

        await JSRuntime.InvokeVoidAsync("initLineChart", "dateTrendChart", labels, datasets, options);
    }

    private (DateTime, DateTime) GetDateRange()
    {
        var today = DateTime.Today;
        return selectedPeriod switch
        {
            "today" => (today, today.AddDays(1)),
            "week" => (today.AddDays(-(int)today.DayOfWeek), today.AddDays(7 - (int)today.DayOfWeek)),
            "month" => (new DateTime(today.Year, today.Month, 1), new DateTime(today.Year, today.Month, 1).AddMonths(1)),
            "custom" => (startDate, endDate.AddDays(1)),
            _ => (today, today.AddDays(1))
        };
    }

    private async Task HandlePeriodChange(ChangeEventArgs e)
    {
        selectedPeriod = e.Value?.ToString() ?? "month";
        await LoadReport();
        StateHasChanged();
    }

    private async Task ExportToExcel()
    {
        try
        {
            if (reportSummary == null)
            {
                return;
            }

            // 生成Excel文件
            var excelBytes = await ExcelExportService.ExportProductionReportAsync(reportSummary, new List<ProductLossRateResponse>());

            // 生成文件名
            var fileName = $"{L["Report_ExportFileName"].Value}_{DateTime.Now:yyyyMMdd_HHmmss}.xlsx";

            // 下载文件
            await JSRuntime.InvokeVoidAsync("downloadFile", fileName, Convert.ToBase64String(excelBytes));
        }
        catch (Exception ex)
        {
            // 记录错误
            Console.WriteLine($"{L["Report_ExportFailed"].Value}: {ex.Message}");
        }
    }

    private decimal GetTotalWeight() => records?.Sum(r => r.Weight) ?? 0;
    private decimal GetAverageWeight() => records?.Count() > 0 ? GetTotalWeight() / records.Count() : 0;
    private int GetBatchCount() => records?.DistinctBy(r => r.Barcode).Count() ?? 0;

    private List<BatchStats> GetBatchStatistics()
    {
        var stats = new List<BatchStats>();
        if (records == null) return stats;

        var batches = records.GroupBy(r => r.Barcode);
        foreach (var batch in batches)
        {
            var weights = batch.Select(r => r.Weight).ToList();
            var batchStats = new BatchStats
            {
                BatchId = batch.First().Barcode,
                RecordCount = batch.Count(),
                TotalWeight = weights.Sum(),
                AverageWeight = weights.Average()
            };
            stats.Add(batchStats);
        }

        return stats.OrderByDescending(s => s.TotalWeight).ToList();
    }

    private class StageStats
    {
        public int Count { get; set; }
        public decimal TotalWeight { get; set; }
        public decimal AverageWeight { get; set; }
        public decimal MaxWeight { get; set; }
        public decimal MinWeight { get; set; }
    }

    private class BatchStats
    {
        public string BatchId { get; set; } = string.Empty;
        public int RecordCount { get; set; }
        public decimal TotalWeight { get; set; }
        public decimal AverageWeight { get; set; }
        public List<StageWeight> Stages { get; set; } = new();
    }

    private class StageWeight
    {
        public string Stage { get; set; } = string.Empty;
        public decimal TotalWeight { get; set; }
    }

}
