@page "/reports/production"
@attribute [Microsoft.AspNetCore.Authorization.Authorize(Policy = "Admin")]
@using Microsoft.Extensions.Localization
@using Minimes.Application.Interfaces
@using Minimes.Application.DTOs.WeighingRecord
@using Minimes.Application.DTOs.Report
@using Minimes.Domain.Enums
@using Minimes.Application.Resources
@inject IStringLocalizer<SharedResource> L
@inject IWeighingRecordService WeighingRecordService
@inject IReportService ReportService
@inject IExcelExportService ExcelExportService
@inject IJSRuntime JSRuntime

<PageTitle>@L["Report_Title"] - MiniMES</PageTitle>

<div class="container-fluid">
    <div class="row mb-4">
        <div class="col">
            <h2>
                <span class="oi oi-graph me-2"></span>@L["Report_Title"]
            </h2>
            <p class="text-muted">@L["Report_Subtitle"]</p>
        </div>
    </div>

    <!-- 日期和过滤器 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-light">
                <div class="card-body">
                    <div class="row g-3 align-items-end">
                        <div class="col-12 col-md-6 col-lg-3">
                            <label class="form-label"><strong>@L["Report_Period"]</strong></label>
                            <select class="form-select form-select-lg" @onchange="HandlePeriodChange">
                                <option value="today">@L["Report_Today"]</option>
                                <option value="week">@L["Report_Week"]</option>
                                <option value="month" selected>@L["Report_Month"]</option>
                                <option value="custom">@L["Report_Custom"]</option>
                            </select>
                        </div>

                        @if (selectedPeriod == "custom")
                        {
                            <div class="col-12 col-sm-6 col-md-4 col-lg-2">
                                <label class="form-label"><strong>@L["Report_StartDate"]</strong></label>
                                <input type="date" class="form-control form-control-lg" @bind="startDate" />
                            </div>
                            <div class="col-12 col-sm-6 col-md-4 col-lg-2">
                                <label class="form-label"><strong>@L["Report_EndDate"]</strong></label>
                                <input type="date" class="form-control form-control-lg" @bind="endDate" />
                            </div>
                        }

                        <div class="col-12 col-md-6 col-lg-3">
                            @* <label class="form-label"><strong>@L["Weighing_ProcessStage"]</strong></label> *@
                            <label class="form-label"><strong>@L["Weighing_Stage"]</strong></label>
                            <select class="form-select form-select-lg" @onchange="HandleStageChange">
                                <option value="">@L["Records_AllStages"]</option>
                                <option value="@ProcessStage.Receiving">@L["Stage_Receiving"]</option>
                                <option value="@ProcessStage.Processing">@L["Stage_Processing"]</option>
                                <option value="@ProcessStage.Shipping">@L["Stage_Shipping"]</option>
                            </select>
                        </div>

                        <div class="col-12 col-sm-6 col-md-4 col-lg-2">
                            <button class="btn btn-primary btn-lg w-100" @onclick="LoadReport" disabled="@isLoading">
                                <span class="oi oi-reload me-1"></span>@L["Report_Refresh"]
                            </button>
                        </div>
                        <div class="col-12 col-sm-6 col-md-4 col-lg-2">
                            <button class="btn btn-success btn-lg w-100" @onclick="ExportToExcel" disabled="@(isLoading || records == null || !records.Any())">
                                <span class="oi oi-data-transfer-download me-1"></span>@L["Report_ExportExcel"]
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    @if (isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">@L["Status_Loading"]</span>
            </div>
            <p class="mt-2 text-muted">@L["Report_Generating"]</p>
        </div>
    }
    else if (records == null || !records.Any())
    {
        <div class="alert alert-info text-center py-5">
            <span class="oi oi-info me-2"></span>
            @L["Report_NoData"]
        </div>
    }
    else
    {
        <!-- 统计汇总卡片 -->
        <div class="row mb-4 g-3">
            <div class="col-12 col-sm-6 col-lg-4">
                <div class="card border-primary h-100">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div>
                                <h6 class="card-subtitle mb-2 text-muted">@L["Report_TotalRecords"]</h6>
                                <h2 class="card-title mb-0">@records.Count()</h2>
                            </div>
                            <div class="ms-auto">
                                <span class="oi oi-list" style="font-size: 2.5rem; color: #0d6efd;"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-6 col-lg-4">
                <div class="card border-success h-100">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div>
                                <h6 class="card-subtitle mb-2 text-muted">@L["Report_TotalWeight"]</h6>
                                <h2 class="card-title mb-0">@($"{GetTotalWeight():F2}") <small>lb</small></h2>
                            </div>
                            <div class="ms-auto">
                                <span class="oi oi-scale" style="font-size: 2.5rem; color: #198754;"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-6 col-lg-4">
                <div class="card border-warning h-100">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div>
                                <h6 class="card-subtitle mb-2 text-muted">@L["Report_AverageWeight"]</h6>
                                <h2 class="card-title mb-0">@($"{GetAverageWeight():F2}") <small>lb</small></h2>
                            </div>
                            <div class="ms-auto">
                                <span class="oi oi-bar-chart" style="font-size: 2.5rem; color: #ffc107;"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 图表展示区域 -->
        <div class="row mb-4">
            <div class="col-md-6 mb-3">
                <div class="card h-100">
                    <div class="card-header bg-primary text-white">
                        <h6 class="mb-0">
                            <span class="oi oi-pie-chart me-2"></span>@L["Report_StageRecordsChart"]
                        </h6>
                    </div>
                    <div class="card-body">
                        <canvas id="stageRecordsChart" style="max-height: 300px;"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6 mb-3">
                <div class="card h-100">
                    <div class="card-header bg-success text-white">
                        <h6 class="mb-0">
                            <span class="oi oi-bar-chart me-2"></span>@L["Report_StageWeightsChart"]
                        </h6>
                    </div>
                    <div class="card-body">
                        <canvas id="stageWeightsChart" style="max-height: 300px;"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- 日期趋势图 -->
        @if (selectedPeriod != "today")
        {
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header bg-info text-white">
                            <h6 class="mb-0">
                                <span class="oi oi-graph me-2"></span>@L["Report_DateTrendChart"]
                            </h6>
                        </div>
                        <div class="card-body">
                            <canvas id="dateTrendChart" style="height: 350px;"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        }

        <!-- 肉类类型分布 -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-warning text-dark">
                        <h6 class="mb-0">
                            <span class="oi oi-list-rich me-2"></span>@L["Report_MeatTypeChart"]
                        </h6>
                    </div>
                    <div class="card-body">
                        <canvas id="meatTypeChart" style="height: 300px;"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- 按加工环节统计 -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">
                            <span class="oi oi-spreadsheet me-2"></span>@L["Report_StageStatistics"]
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead class="table-light">
                                    <tr>
                                        @* <th>@L["Weighing_ProcessStage"]</th> *@
                                        <th>@L["Weighing_Stage"]</th>
                                        <th>@L["Report_RecordCount"]</th>
                                        <th>@L["Report_TotalWeight"] (lb)</th>
                                        <th>@L["Report_AverageWeight"] (lb)</th>
                                        <th>@L["Report_MaxWeight"] (lb)</th>
                                        <th>@L["Report_MinWeight"] (lb)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var stage in GetStageStatistics())
                                    {
                                        <tr>
                                            <td>
                                                <strong>@stage.Key</strong>
                                            </td>
                                            <td>@stage.Value.Count</td>
                                            <td>@stage.Value.TotalWeight.ToString("F2")</td>
                                            <td>@stage.Value.AverageWeight.ToString("F2")</td>
                                            <td>@stage.Value.MaxWeight.ToString("F2")</td>
                                            <td>@stage.Value.MinWeight.ToString("F2")</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        @* 批次维度统计暂时隐藏，目前还没有批次业务
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">
                            <span class="oi oi-list-rich me-2"></span>批次维度统计
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>批次ID</th>
                                        <th>记录数</th>
                                        <th>总重量 (lb)</th>
                                        <th>平均单次 (lb)</th>
                                        <th>原料入库</th>
                                        <th>加工过程</th>
                                        <th>成品出库</th>
                                        <th>损耗率</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var batch in GetBatchStatistics())
                                    {
                                        var receivingWeight = batch.Stages.FirstOrDefault(s => s.Stage == ProcessStage.Receiving)?.TotalWeight ?? 0;
                                        var shippingWeight = batch.Stages.FirstOrDefault(s => s.Stage == ProcessStage.Shipping)?.TotalWeight ?? 0;
                                        var lossRate = receivingWeight > 0 ? ((receivingWeight - shippingWeight) / receivingWeight * 100) : 0;

                                        <tr>
                                            <td><code>@batch.BatchId</code></td>
                                            <td>@batch.RecordCount</td>
                                            <td>@batch.TotalWeight.ToString("F2")</td>
                                            <td>@batch.AverageWeight.ToString("F2")</td>
                                            <td>@receivingWeight.ToString("F2")</td>
                                            <td>@(batch.Stages.FirstOrDefault(s => s.Stage == ProcessStage.Processing)?.TotalWeight.ToString("F2") ?? "0.00")</td>
                                            <td>@shippingWeight.ToString("F2")</td>
                                            <td>
                                                @if (lossRate > 0)
                                                {
                                                    <span class="badge bg-warning">@lossRate.ToString("F1")%</span>
                                                }
                                                else
                                                {
                                                    <span class="badge bg-secondary">0%</span>
                                                }
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        *@

        <!-- 商品损耗率统计 - 质量追溯核心功能 -->
        @if (lossRates != null && lossRates.Any())
        {
            <!-- 损耗率TOP10图表 -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card border-danger">
                        <div class="card-header bg-danger text-white">
                            <h6 class="mb-0">
                                <span class="oi oi-warning me-2"></span>@L["Report_LossRateTopChart"]
                            </h6>
                        </div>
                        <div class="card-body">
                            <canvas id="lossRateChart" style="height: 400px;"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mb-4">
                <div class="col-md-12">
                    <div class="card border-danger">
                        <div class="card-header bg-danger text-white">
                            <h5 class="mb-0">
                                <span class="oi oi-warning me-2"></span>@L["Report_LossRateTitle"]
                            </h5>
                        </div>
                        <div class="card-body">
                            <p class="text-muted mb-3">
                                <small>
                                    <strong>@L["Report_LossRateFormula"]：</strong> @L["Report_LossRateFormulaDesc"]
                                </small>
                            </p>
                            <div class="table-responsive">
                                <table class="table table-sm table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>@L["Tracing_Barcode"]</th>
                                            <th>@L["Report_ReceivingWeight"] (lb)</th>
                                            <th>@L["Report_ProcessingWeight"] (lb)</th>
                                            <th>@L["Report_ShippingWeight"] (lb)</th>
                                            <th>@L["Report_LossWeight"] (lb)</th>
                                            <th>@L["Report_LossRate"]</th>
                                            <th>@L["Report_RecordCount"]</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var item in lossRates.OrderByDescending(l => l.LossRate))
                                        {
                                            var lossRateClass = item.LossRate > 20 ? "danger" :
                                                                item.LossRate > 10 ? "warning" :
                                                                item.LossRate > 5 ? "info" : "success";

                                            <tr>
                                                <td><code>@item.Barcode</code></td>
                                                <td>@item.ReceivingWeight.ToString("F3")</td>
                                                <td>@item.ProcessingWeight.ToString("F3")</td>
                                                <td>@item.ShippingWeight.ToString("F3")</td>
                                                <td>@item.LossWeight.ToString("F3")</td>
                                                <td>
                                                    <span class="badge bg-@lossRateClass">
                                                        @item.LossRate.ToString("F1")%
                                                    </span>
                                                </td>
                                                <td>
                                                    <small class="text-muted">
                                                        入:@item.ReceivingRecords /
                                                        加:@item.ProcessingRecords /
                                                        出:@item.ShippingRecords
                                                    </small>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }
    }
</div>

@code {
    private List<WeighingRecordResponse>? records;
    private ProductionReportResponse? reportSummary;
    private List<ProductLossRateResponse>? lossRates;
    private string selectedPeriod = "month";
    private int? selectedStageId = null;
    private DateTime startDate = DateTime.Today.AddDays(-30);
    private DateTime endDate = DateTime.Today;
    private bool isLoading = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadReport();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        // 每次数据加载后初始化图表
        if (records != null && records.Any())
        {
            await Task.Delay(100); // 等待DOM更新
            await InitializeCharts();
        }
    }

    private async Task LoadReport()
    {
        isLoading = true;
        try
        {
            // 计算日期范围
            var (start, end) = GetDateRange();

            // 加载称重记录列表
            var query = new WeighingRecordQueryRequest
            {
                StartDate = start,
                EndDate = end,
                ProcessStageId = selectedStageId,
                PageNumber = 1,
                PageSize = 10000
            };

            var (recordsList, _) = await WeighingRecordService.QueryAsync(query);
            records = recordsList;

            // 加载生产报表统计
            var reportRequest = new ProductionReportRequest
            {
                StartDate = start,
                EndDate = end,
                ProcessStageId = selectedStageId
            };
            reportSummary = await ReportService.GetProductionReportAsync(reportRequest);

            // 加载条码损耗率统计
            lossRates = await ReportService.GetBarcodeLossRateAsync(start, end);
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task InitializeCharts()
    {
        if (records == null || !records.Any())
            return;

        try
        {
            // 初始化环节记录分布饼图
            await InitializeStageRecordsChart();
            // 初始化环节重量对比柱状图
            await InitializeStageWeightsChart();
            // 初始化肉类类型分布图
            await InitializeMeatTypeChart();
            // 如果不是今日报表，初始化日期趋势图
            if (selectedPeriod != "today")
            {
                await InitializeDateTrendChart();
            }
            // 初始化损耗率图表
            if (lossRates != null && lossRates.Any())
            {
                await InitializeLossRateChart();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"图表初始化失败: {ex.Message}");
        }
    }

    private async Task InitializeStageRecordsChart()
    {
        var stageStats = GetStageStatistics();
        if (!stageStats.Any())
            return;

        var labels = stageStats.Keys.ToList();
        var data = stageStats.Values.Select(s => s.Count).ToList();
        var backgroundColor = new[] { "#FF6384", "#36A2EB", "#FFCE56" };

        await JSRuntime.InvokeVoidAsync("initPieChart", "stageRecordsChart", labels, data, backgroundColor);
    }

    private async Task InitializeStageWeightsChart()
    {
        var stageStats = GetStageStatistics();
        if (!stageStats.Any())
            return;

        var labels = stageStats.Keys.ToList();
        var weightData = stageStats.Values.Select(s => s.TotalWeight).ToList();

        var datasets = new object[]
        {
            new
            {
                label = L["Chart_TotalWeight"].Value,
                data = weightData,
                backgroundColor = new[] { "#FF6384", "#36A2EB", "#FFCE56" },
                borderColor = "#fff",
                borderWidth = 2
            }
        };

        var options = new
        {
            responsive = true,
            maintainAspectRatio = true,
            plugins = new { legend = new { display = false } },
            scales = new { y = new { beginAtZero = true, title = new { display = true, text = L["Chart_WeightAxis"].Value } } }
        };

        await JSRuntime.InvokeVoidAsync("initBarChart", "stageWeightsChart", labels, datasets, options);
    }

    private async Task InitializeMeatTypeChart()
    {
        if (records == null || !records.Any())
            return;

        // 按肉类类型分组统计
        var meatTypeGroups = records
            .GroupBy(r => r.MeatTypeName)
            .OrderByDescending(g => g.Count())
            .Select(g => new { Type = g.Key, Count = g.Count(), Weight = g.Sum(x => x.Weight) })
            .ToList();

        if (!meatTypeGroups.Any())
            return;

        var labels = meatTypeGroups.Select(m => m.Type).ToList();
        var countData = meatTypeGroups.Select(m => m.Count).ToList();
        var weightData = meatTypeGroups.Select(m => m.Weight).ToList();

        var datasets = new object[]
        {
            new
            {
                label = L["Chart_RecordCount"].Value,
                data = countData,
                backgroundColor = "#36A2EB",
                borderColor = "#36A2EB",
                borderWidth = 2,
                yAxisID = "y"
            },
            new
            {
                label = L["Chart_TotalWeight"].Value,
                data = weightData,
                backgroundColor = "#FF6384",
                borderColor = "#FF6384",
                borderWidth = 2,
                yAxisID = "y1"
            }
        };

        var options = new
        {
            responsive = true,
            maintainAspectRatio = false,
            interaction = new { mode = "index", intersect = false },
            plugins = new { legend = new { display = true, position = "top" } },
            scales = new
            {
                y = new { type = "linear", display = true, position = "left", title = new { display = true, text = L["Chart_RecordCount"].Value } },
                y1 = new { type = "linear", display = true, position = "right", title = new { display = true, text = L["Chart_WeightAxis"].Value }, grid = new { drawOnChartArea = false } }
            }
        };

        await JSRuntime.InvokeVoidAsync("initBarChart", "meatTypeChart", labels, datasets, options);
    }

    private async Task InitializeDateTrendChart()
    {
        if (records == null || !records.Any())
            return;

        // 按日期分组统计
        var dateGroups = records
            .GroupBy(r => r.CreatedAt.Date)
            .OrderBy(g => g.Key)
            .Select(g => new
            {
                Date = g.Key,
                Count = g.Count(),
                Weight = g.Sum(r => r.Weight)
            })
            .ToList();

        if (!dateGroups.Any())
            return;

        var labels = dateGroups.Select(d => d.Date.ToString("MM-dd")).ToList();
        var countData = dateGroups.Select(d => d.Count).ToList();
        var weightData = dateGroups.Select(d => d.Weight).ToList();

        var datasets = new object[]
        {
            new
            {
                label = L["Chart_RecordCount"].Value,
                data = countData,
                borderColor = "#36A2EB",
                backgroundColor = "rgba(54, 162, 235, 0.1)",
                borderWidth = 2,
                fill = true,
                yAxisID = "y"
            },
            new
            {
                label = L["Chart_TotalWeight"].Value,
                data = weightData,
                borderColor = "#FF6384",
                backgroundColor = "rgba(255, 99, 132, 0.1)",
                borderWidth = 2,
                fill = true,
                yAxisID = "y1"
            }
        };

        var options = new
        {
            responsive = true,
            maintainAspectRatio = false,
            interaction = new { mode = "index", intersect = false },
            plugins = new { legend = new { display = true, position = "top" } },
            scales = new
            {
                y = new { type = "linear", display = true, position = "left", title = new { display = true, text = L["Chart_RecordCount"].Value }, beginAtZero = true },
                y1 = new { type = "linear", display = true, position = "right", title = new { display = true, text = L["Chart_WeightAxis"].Value }, grid = new { drawOnChartArea = false }, beginAtZero = true }
            }
        };

        await JSRuntime.InvokeVoidAsync("initLineChart", "dateTrendChart", labels, datasets, options);
    }

    private async Task InitializeLossRateChart()
    {
        if (lossRates == null || !lossRates.Any())
            return;

        // 取损耗率最高的TOP10
        var topLossRates = lossRates
            .OrderByDescending(l => l.LossRate)
            .Take(10)
            .ToList();

        if (!topLossRates.Any())
            return;

        var labels = topLossRates.Select(l => l.Barcode).ToList();
        var data = topLossRates.Select(l => l.LossRate).ToList();

        // 根据损耗率设置颜色（红黄绿）
        var backgroundColor = topLossRates.Select(l =>
            l.LossRate > 20 ? "#dc3545" :  // 红色
            l.LossRate > 10 ? "#ffc107" :  // 黄色
            l.LossRate > 5 ? "#0dcaf0" :   // 蓝色
            "#198754"                       // 绿色
        ).ToArray();

        var datasets = new object[]
        {
            new
            {
                label = L["Chart_LossRatePercent"].Value,
                data = data,
                backgroundColor = backgroundColor,
                borderColor = "#fff",
                borderWidth = 1
            }
        };

        var options = new
        {
            responsive = true,
            maintainAspectRatio = false,
            indexAxis = "y",  // 横向柱状图
            plugins = new
            {
                legend = new { display = false },
                title = new { display = true, text = L["Chart_LossRateLegend"].Value }
            },
            scales = new
            {
                x = new { beginAtZero = true, title = new { display = true, text = L["Chart_LossRatePercent"].Value } }
            }
        };

        await JSRuntime.InvokeVoidAsync("initBarChart", "lossRateChart", labels, datasets, options);
    }

    private (DateTime, DateTime) GetDateRange()
    {
        var today = DateTime.Today;
        return selectedPeriod switch
        {
            "today" => (today, today.AddDays(1)),
            "week" => (today.AddDays(-(int)today.DayOfWeek), today.AddDays(7 - (int)today.DayOfWeek)),
            "month" => (new DateTime(today.Year, today.Month, 1), new DateTime(today.Year, today.Month, 1).AddMonths(1)),
            "custom" => (startDate, endDate.AddDays(1)),
            _ => (today, today.AddDays(1))
        };
    }

    private async Task HandlePeriodChange(ChangeEventArgs e)
    {
        selectedPeriod = e.Value?.ToString() ?? "month";
        await LoadReport();
        StateHasChanged();
    }

    private async Task HandleStageChange(ChangeEventArgs e)
    {
        var value = e.Value?.ToString();
        selectedStageId = string.IsNullOrEmpty(value) ? null : int.Parse(value);
        await LoadReport();
        StateHasChanged();
    }

    private async Task ExportToExcel()
    {
        try
        {
            if (reportSummary == null || lossRates == null)
            {
                return;
            }

            // 生成Excel文件
            var excelBytes = await ExcelExportService.ExportProductionReportAsync(reportSummary, lossRates);

            // 生成文件名
            var fileName = $"{L["Report_ExportFileName"].Value}_{DateTime.Now:yyyyMMdd_HHmmss}.xlsx";

            // 下载文件
            await JSRuntime.InvokeVoidAsync("downloadFile", fileName, Convert.ToBase64String(excelBytes));
        }
        catch (Exception ex)
        {
            // 记录错误
            Console.WriteLine($"{L["Report_ExportFailed"].Value}: {ex.Message}");
        }
    }

    private decimal GetTotalWeight() => records?.Sum(r => r.Weight) ?? 0;
    private decimal GetAverageWeight() => records?.Count() > 0 ? GetTotalWeight() / records.Count() : 0;
    private int GetBatchCount() => records?.DistinctBy(r => r.Barcode).Count() ?? 0;

    private Dictionary<string, StageStats> GetStageStatistics()
    {
        var stats = new Dictionary<string, StageStats>();
        if (records == null) return stats;

        var grouped = records.GroupBy(r => r.ProcessStageName);
        foreach (var group in grouped)
        {
            var stageName = GetLocalizedStageName(group.Key);

            var weights = group.Select(r => r.Weight).ToList();
            stats[stageName] = new StageStats
            {
                Count = group.Count(),
                TotalWeight = weights.Sum(),
                AverageWeight = weights.Average(),
                MaxWeight = weights.Max(),
                MinWeight = weights.Min()
            };
        }

        return stats;
    }

    private List<BatchStats> GetBatchStatistics()
    {
        var stats = new List<BatchStats>();
        if (records == null) return stats;

        var batches = records.GroupBy(r => r.Barcode);
        foreach (var batch in batches)
        {
            var weights = batch.Select(r => r.Weight).ToList();
            var batchStats = new BatchStats
            {
                BatchId = batch.First().Barcode,
                RecordCount = batch.Count(),
                TotalWeight = weights.Sum(),
                AverageWeight = weights.Average(),
                Stages = batch.GroupBy(r => r.ProcessStageName)
                    .Select(s => new StageWeight
                    {
                        Stage = s.Key,
                        TotalWeight = s.Sum(r => r.Weight)
                    }).ToList()
            };
            stats.Add(batchStats);
        }

        return stats.OrderByDescending(s => s.TotalWeight).ToList();
    }

    private class StageStats
    {
        public int Count { get; set; }
        public decimal TotalWeight { get; set; }
        public decimal AverageWeight { get; set; }
        public decimal MaxWeight { get; set; }
        public decimal MinWeight { get; set; }
    }

    private class BatchStats
    {
        public string BatchId { get; set; } = string.Empty;
        public int RecordCount { get; set; }
        public decimal TotalWeight { get; set; }
        public decimal AverageWeight { get; set; }
        public List<StageWeight> Stages { get; set; } = new();
    }

    private class StageWeight
    {
        public string Stage { get; set; } = string.Empty;
        public decimal TotalWeight { get; set; }
    }

    private string GetLocalizedStageName(string stageName)
    {
        var normalized = stageName.ToLower().Trim();
        if (normalized.Contains("receiving") || normalized.Contains("入库") || normalized.Contains("原料"))
            return L["Stage_Receiving"];
        if (normalized.Contains("processing") || normalized.Contains("加工"))
            return L["Stage_Processing"];
        if (normalized.Contains("shipping") || normalized.Contains("出库") || normalized.Contains("成品"))
            return L["Stage_Shipping"];
        return stageName;
    }
}
