@page "/devices/{DeviceId}"
@using Minimes.Application.Interfaces
@using Minimes.Application.DTOs.Device
@using Minimes.Application.Resources
@using Microsoft.AspNetCore.SignalR.Client
@using Microsoft.Extensions.Localization
@inject IDeviceManagementService DeviceService
@inject IStringLocalizer<SharedResource> L
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthenticationStateProvider
@attribute [Authorize(Policy = "Operator")]

<PageTitle>@L["Device_Detail"] - @(deviceDetail?.DeviceName ?? DeviceId)</PageTitle>

<div class="container-fluid mt-4">
    <!-- 面包屑导航 -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a href="/devices/monitor">@L["Device_Monitor"]</a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">
                @L["Device_Detail"]
            </li>
        </ol>
    </nav>

    <!-- 页面标题 -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2>@L["Device_Detail"] - @(deviceDetail?.DeviceName ?? DeviceId)</h2>
        </div>
        <div>
            <button class="btn btn-secondary" @onclick="GoBack">
                <i class="bi bi-arrow-left"></i> @L["Device_BackToList"]
            </button>
            @if (isAdmin)
            {
                <button class="btn btn-primary ms-2" @onclick="ShowControlPanel">
                    <i class="bi bi-gear"></i> @L["Device_Control"]
                </button>
                <button class="btn btn-info ms-2" @onclick="ShowConfiguration">
                    <i class="bi bi-sliders"></i> @L["Device_Configure"]
                </button>
            }
        </div>
    </div>

    @if (isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">@L["Status_Loading"]</span>
            </div>
            <p class="mt-3">@L["Device_LoadingData"]</p>
        </div>
    }
    else if (deviceDetail == null)
    {
        <div class="alert alert-warning" role="alert">
            <i class="bi bi-exclamation-triangle"></i>
            @L["Device_NotFound"]
        </div>
    }
    else
    {
        <div class="row">
            <!-- 设备基本信息卡片 -->
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-info-circle"></i> @L["Device_BasicInfo"]
                        </h5>
                    </div>
                    <div class="card-body">
                        <table class="table table-borderless">
                            <tbody>
                                <tr>
                                    <th style="width: 40%;">@L["Device_DeviceId"]:</th>
                                    <td><code>@deviceDetail.DeviceId</code></td>
                                </tr>
                                <tr>
                                    <th>@L["Device_Name"]:</th>
                                    <td>@deviceDetail.DeviceName</td>
                                </tr>
                                <tr>
                                    <th>@L["Device_Type"]:</th>
                                    <td>
                                        <span class="badge bg-info">@GetDeviceTypeDisplay(deviceDetail.DeviceType)</span>
                                    </td>
                                </tr>
                                <tr>
                                    <th>@L["Device_Manufacturer"]:</th>
                                    <td>@(deviceDetail.Manufacturer ?? "-")</td>
                                </tr>
                                <tr>
                                    <th>@L["Device_Model"]:</th>
                                    <td>@(deviceDetail.Model ?? "-")</td>
                                </tr>
                                <tr>
                                    <th>@L["Device_SerialNumber"]:</th>
                                    <td>@(deviceDetail.SerialNumber ?? "-")</td>
                                </tr>
                                <tr>
                                    <th>@L["Device_ProtocolType"]:</th>
                                    <td><code>@deviceDetail.ProtocolType</code></td>
                                </tr>
                                <tr>
                                    <th>@L["Device_DataType"]:</th>
                                    <td><code>@deviceDetail.DataType</code></td>
                                </tr>
                                <tr>
                                    <th>@L["Device_Status"]:</th>
                                    <td>
                                        <span class="badge @GetStatusBadgeClass(deviceDetail.State)">
                                            @GetDeviceStatusDisplay(deviceDetail.State)
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <th>@L["Device_ConnectedAt"]:</th>
                                    <td>@(deviceDetail.ConnectedAt?.ToString("yyyy-MM-dd HH:mm:ss") ?? "-")</td>
                                </tr>
                                <tr>
                                    <th>@L["Device_ErrorCount"]:</th>
                                    <td>
                                        <span class="badge @(deviceDetail.ErrorCount > 0 ? "bg-danger" : "bg-success")">
                                            @deviceDetail.ErrorCount
                                        </span>
                                    </td>
                                </tr>
                                @if (!string.IsNullOrEmpty(deviceDetail.LastError))
                                {
                                    <tr>
                                        <th>@L["Device_LastError"]:</th>
                                        <td class="text-danger">
                                            <small>@deviceDetail.LastError</small>
                                            <br />
                                            <small class="text-muted">@deviceDetail.LastErrorAt?.ToString("yyyy-MM-dd HH:mm:ss")</small>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>

                        @if (deviceDetail.Capabilities.Any())
                        {
                            <div class="mt-3">
                                <strong>@L["Device_Capabilities"]:</strong>
                                <div class="mt-2">
                                    @foreach (var capability in deviceDetail.Capabilities)
                                    {
                                        <span class="badge bg-secondary me-1">@capability</span>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <!-- 设备健康状态卡片 -->
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-heart-pulse"></i> @L["Device_Health"]
                        </h5>
                    </div>
                    <div class="card-body">
                        @if (deviceHealth != null)
                        {
                            <div class="mb-3">
                                <label class="form-label">@L["Device_HealthScore"]:</label>
                                <div class="progress" style="height: 30px;">
                                    <div class="progress-bar @GetHealthScoreClass(deviceHealth.HealthScore)"
                                         role="progressbar"
                                         style="width: @(deviceHealth.HealthScore)%;"
                                         aria-valuenow="@deviceHealth.HealthScore"
                                         aria-valuemin="0"
                                         aria-valuemax="100">
                                        @deviceHealth.HealthScore / 100
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">@L["Device_Uptime"]:</label>
                                <p class="mb-0">
                                    <strong>@FormatUptime(deviceHealth.UptimeSeconds)</strong>
                                </p>
                            </div>

                            @if (deviceHealth.LastHeartbeat.HasValue)
                            {
                                <div class="mb-3">
                                    <label class="form-label">@L["Device_LastHeartbeat"]:</label>
                                    <p class="mb-0">@deviceHealth.LastHeartbeat.Value.ToString("yyyy-MM-dd HH:mm:ss")</p>
                                </div>
                            }

                            @if (deviceHealth.Diagnostics.Any())
                            {
                                <div class="mb-3">
                                    <label class="form-label">@L["Device_Diagnostics"]:</label>
                                    <table class="table table-sm table-bordered">
                                        <tbody>
                                            @foreach (var diag in deviceHealth.Diagnostics)
                                            {
                                                <tr>
                                                    <th style="width: 40%;">@diag.Key:</th>
                                                    <td>@diag.Value</td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            }

                            @if (deviceHealth.Warnings.Any())
                            {
                                <div class="alert alert-warning mb-0">
                                    <strong>@L["Device_Warnings"]:</strong>
                                    <ul class="mb-0 mt-2">
                                        @foreach (var warning in deviceHealth.Warnings)
                                        {
                                            <li>@warning</li>
                                        }
                                    </ul>
                                </div>
                            }
                            else
                            {
                                <div class="alert alert-success mb-0">
                                    <i class="bi bi-check-circle"></i> @L["Device_NoWarnings"]
                                </div>
                            }
                        }
                        else
                        {
                            <div class="alert alert-info mb-0">
                                @L["Device_HealthDataUnavailable"]
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- 设备日志表格 -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-dark text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-journal-text"></i> @L["Device_Logs"]
                        </h5>
                    </div>
                    <div class="card-body">
                        @if (deviceLogs.Any())
                        {
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead>
                                        <tr>
                                            <th style="width: 10%;">@L["Device_LogLevel"]</th>
                                            <th style="width: 20%;">@L["Device_LogTime"]</th>
                                            <th style="width: 60%;">@L["Device_LogMessage"]</th>
                                            <th style="width: 10%;">@L["Device_LogDetails"]</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var log in pagedLogs)
                                        {
                                            <tr>
                                                <td>
                                                    <span class="badge @GetLogLevelBadgeClass(log.Level)">
                                                        @log.Level
                                                    </span>
                                                </td>
                                                <td>
                                                    <small>@log.Timestamp.ToString("yyyy-MM-dd HH:mm:ss")</small>
                                                </td>
                                                <td>
                                                    @log.Message
                                                    @if (!string.IsNullOrEmpty(log.Exception))
                                                    {
                                                        <br />
                                                        <small class="text-danger">@log.Exception</small>
                                                    }
                                                </td>
                                                <td>
                                                    @if (log.Data != null && log.Data.Any())
                                                    {
                                                        <button class="btn btn-sm btn-outline-secondary"
                                                                @onclick="() => ShowLogDetails(log)">
                                                            <i class="bi bi-eye"></i>
                                                        </button>
                                                    }
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>

                            <!-- 分页控件 -->
                            <nav aria-label="Page navigation">
                                <ul class="pagination justify-content-center mb-0">
                                    <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                                        <button class="page-link" @onclick="() => ChangePage(currentPage - 1)">
                                            @L["Records_PrevPage"]
                                        </button>
                                    </li>
                                    @for (int i = 1; i <= totalPages; i++)
                                    {
                                        var pageNum = i;
                                        <li class="page-item @(currentPage == pageNum ? "active" : "")">
                                            <button class="page-link" @onclick="() => ChangePage(pageNum)">
                                                @pageNum
                                            </button>
                                        </li>
                                    }
                                    <li class="page-item @(currentPage == totalPages ? "disabled" : "")">
                                        <button class="page-link" @onclick="() => ChangePage(currentPage + 1)">
                                            @L["Records_NextPage"]
                                        </button>
                                    </li>
                                </ul>
                            </nav>
                        }
                        else
                        {
                            <div class="alert alert-info mb-0">
                                <i class="bi bi-info-circle"></i> @L["Device_NoLogs"]
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    [Parameter]
    public string DeviceId { get; set; } = string.Empty;

    private DeviceDetailDto? deviceDetail;
    private DeviceHealthDto? deviceHealth;
    private List<DeviceLogDto> deviceLogs = new();
    private List<DeviceLogDto> pagedLogs = new();

    private bool isLoading = true;
    private bool isAdmin = false;
    private HubConnection? hubConnection;

    // 分页相关
    private int currentPage = 1;
    private int pageSize = 10;
    private int totalPages = 1;

    protected override async Task OnInitializedAsync()
    {
        await CheckAdminRole();
        await LoadDeviceData();
        await InitializeSignalR();
    }

    private async Task CheckAdminRole()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        isAdmin = user.IsInRole("Administrator");
    }

    private async Task LoadDeviceData()
    {
        try
        {
            isLoading = true;

            // 加载设备详情
            deviceDetail = await DeviceService.GetDeviceDetailAsync(DeviceId);

            if (deviceDetail == null)
            {
                return;
            }

            // 加载健康状态
            deviceHealth = await DeviceService.GetDeviceHealthAsync(DeviceId);

            // 加载设备日志
            var logs = await DeviceService.GetDeviceLogsAsync(DeviceId, 100);
            deviceLogs = logs.OrderByDescending(l => l.Timestamp).ToList();

            UpdatePagedLogs();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"加载设备数据失败: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task InitializeSignalR()
    {
        try
        {
            hubConnection = new HubConnectionBuilder()
                .WithUrl(Navigation.ToAbsoluteUri("/hardwareHub"))
                .WithAutomaticReconnect()
                .Build();

            hubConnection.On<string, string, object>("ReceiveDeviceStatusUpdate",
                (deviceId, status, data) =>
            {
                if (deviceId == DeviceId)
                {
                    InvokeAsync(async () =>
                    {
                        await LoadDeviceData();
                        StateHasChanged();
                    });
                }
            });

            await hubConnection.StartAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"SignalR连接失败: {ex.Message}");
        }
    }

    private void UpdatePagedLogs()
    {
        totalPages = (int)Math.Ceiling(deviceLogs.Count / (double)pageSize);
        pagedLogs = deviceLogs
            .Skip((currentPage - 1) * pageSize)
            .Take(pageSize)
            .ToList();
    }

    private void ChangePage(int page)
    {
        if (page < 1 || page > totalPages) return;
        currentPage = page;
        UpdatePagedLogs();
    }

    private void GoBack()
    {
        Navigation.NavigateTo("/devices/monitor");
    }

    private void ShowControlPanel()
    {
        // TODO: 实现设备控制面板
        Console.WriteLine("显示设备控制面板");
    }

    private void ShowConfiguration()
    {
        // TODO: 实现设备配置页面
        Console.WriteLine("显示设备配置");
    }

    private void ShowLogDetails(DeviceLogDto log)
    {
        // TODO: 实现日志详情弹窗
        Console.WriteLine($"显示日志详情: {log.Id}");
    }

    // 辅助方法：获取设备类型显示文本
    private string GetDeviceTypeDisplay(string deviceType)
    {
        return deviceType switch
        {
            "Scale" => L["Device_Type_Scale"],
            "BarcodeScanner" => L["Device_Type_BarcodeScanner"],
            "DewPointMeter" => L["Device_Type_DewPointMeter"],
            _ => deviceType
        };
    }

    // 辅助方法：获取设备状态显示文本
    private string GetDeviceStatusDisplay(string state)
    {
        return state switch
        {
            "Uninitialized" => L["Device_Status_Uninitialized"],
            "Disconnected" => L["Device_Status_Disconnected"],
            "Connecting" => L["Device_Status_Connecting"],
            "Connected" => L["Device_Status_Connected"],
            "Running" => L["Device_Status_Running"],
            "Paused" => L["Device_Status_Paused"],
            "Error" => L["Device_Status_Error"],
            "Demo" => L["Device_Status_Demo"],
            _ => state
        };
    }

    // 辅助方法：获取状态徽章样式
    private string GetStatusBadgeClass(string state)
    {
        return state switch
        {
            "Running" => "bg-success",
            "Connected" => "bg-info",
            "Connecting" => "bg-warning",
            "Paused" => "bg-secondary",
            "Error" => "bg-danger",
            "Demo" => "bg-warning",
            _ => "bg-secondary"
        };
    }

    // 辅助方法：获取健康分数进度条样式
    private string GetHealthScoreClass(int score)
    {
        if (score >= 80) return "bg-success";
        if (score >= 60) return "bg-warning";
        return "bg-danger";
    }

    // 辅助方法：获取日志级别徽章样式
    private string GetLogLevelBadgeClass(string level)
    {
        return level switch
        {
            "Error" => "bg-danger",
            "Warning" => "bg-warning",
            "Info" => "bg-info",
            _ => "bg-secondary"
        };
    }

    // 辅助方法：格式化运行时长
    private string FormatUptime(long seconds)
    {
        var timeSpan = TimeSpan.FromSeconds(seconds);

        if (timeSpan.TotalDays >= 1)
        {
            return $"{(int)timeSpan.TotalDays} {L["Settings_Days"]} {timeSpan.Hours} {L["Settings_Hours"]}";
        }
        else if (timeSpan.TotalHours >= 1)
        {
            return $"{(int)timeSpan.TotalHours} {L["Settings_Hours"]} {timeSpan.Minutes} {L["Settings_Minutes"]}";
        }
        else
        {
            return $"{(int)timeSpan.TotalMinutes} {L["Settings_Minutes"]}";
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (hubConnection != null)
        {
            await hubConnection.DisposeAsync();
        }
    }
}

