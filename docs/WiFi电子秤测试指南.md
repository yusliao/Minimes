# WiFi电子秤测试指南

## 📋 测试准备

### 环境要求
- ✅ .NET 8.0 SDK
- ✅ Python 3.x（用于运行模拟电子秤服务器）
- ✅ 浏览器（Chrome/Edge推荐）

---

## 🚀 快速开始

### 方法1：使用模拟电子秤（推荐）

**步骤1：启动模拟电子秤服务器**

```bash
# Windows
cd D:\MyDomain\src\AI\minimes\tools
python MockWiFiScale.py

# 或者双击启动脚本
start_mock_scale.bat
```

启动成功后会看到：
```
============================================================
🔧 模拟WiFi电子秤服务器启动成功
============================================================
服务地址: http://0.0.0.0:8080
重量API: http://0.0.0.0:8080/api/weight
去皮API: http://0.0.0.0:8080/api/tare (POST)
============================================================
量程: 0-20 kg (自动随机变化)
精度: 0.01 kg
稳定率: 90%
============================================================
```

**步骤2：配置MiniMES系统**

编辑 `src/Minimes.Web/appsettings.json`：

```json
{
  "Hardware": {
    "ScaleType": "WiFi",
    "WiFiScale": {
      "IpAddress": "localhost",
      "Port": 8080,
      "Protocol": "HTTP",
      "WeightApiPath": "/api/weight",
      "TareApiPath": "/api/tare"
    }
  }
}
```

**步骤3：启动MiniMES应用**

```bash
cd src/Minimes.Web
dotnet run
```

**步骤4：打开浏览器测试**

访问：`https://localhost:5001/hardware-test`

---

### 方法2：使用真实WiFi电子秤

**前提条件**：
- ✅ WiFi电子秤已连接到同一局域网
- ✅ 知道电子秤的IP地址（例如：192.168.1.200）
- ✅ 知道电子秤的API路径

**配置步骤**：

1. 查找电子秤IP地址（通过电子秤显示屏或路由器管理界面）
2. 查阅电子秤厂家文档，确认API路径
3. 修改 `appsettings.json`：

```json
{
  "Hardware": {
    "ScaleType": "WiFi",
    "WiFiScale": {
      "IpAddress": "192.168.1.200",
      "Port": 80,
      "Protocol": "HTTP",
      "WeightApiPath": "/api/weight",
      "TareApiPath": "/api/tare",
      "ReadIntervalMs": 500,
      "ConnectionTimeoutMs": 5000
    }
  }
}
```

---

## 🧪 测试清单

### 1. 基础连接测试 ✅

访问 `/hardware-test` 页面，检查：

- [ ] 电子秤连接状态显示为"已连接"（绿色）
- [ ] 能看到实时重量数据更新
- [ ] 重量数据刷新频率正常（约每500ms一次）

**预期结果**：
```
连接状态：✅ 已连接
重量：12.35 g
✓ 重量稳定
```

---

### 2. 去皮功能测试 ✅

**测试步骤**：
1. 等待重量稳定
2. 点击"去皮（清零）"按钮
3. 观察重量是否归零

**预期结果**：
- 去皮前：显示实际重量（例如：12.35 kg）
- 去皮后：重量归零（0.00 kg）
- 日志显示：`去皮操作已执行`

---

### 3. 稳定性检测测试 ✅

**测试步骤**：
1. 观察重量是否有"稳定"/"变化中"的状态切换
2. 模拟秤上放置物品（重量变化）
3. 观察是否显示"⚠ 重量变化中"
4. 等待重量稳定
5. 观察是否显示"✓ 重量稳定"

**预期结果**：
- 重量变化时：黄色徽章 + "⚠ 重量变化中"
- 重量稳定时：绿色徽章 + "✓ 重量稳定"

---

### 4. 单位转换测试 ✅

**测试场景**：电子秤返回kg单位，系统应自动转换为克

**验证方法**：
- 电子秤返回：`{"weight": 12.5, "unit": "kg"}`
- 系统显示：`12500 g`

**预期结果**：单位正确转换（1 kg = 1000 g）

---

### 5. 异常处理测试 ⚠️

#### 5.1 网络断开测试

**测试步骤**：
1. 连接成功后，关闭模拟电子秤服务器
2. 观察系统反应

**预期结果**：
- 连接状态变为"未连接"（红色）
- 日志显示错误信息
- 系统不会崩溃

#### 5.2 超时测试

**测试步骤**：
1. 修改 `appsettings.json`，设置错误的IP地址
2. 点击"连接电子秤"
3. 观察5秒后的反应

**预期结果**：
- 显示连接超时错误
- 日志显示：`连接超时（5000ms）- 请检查IP地址和网络连接`

#### 5.3 数据格式兼容性测试

**测试不同的JSON格式**：

```json
// 格式1：A&D标准格式
{"weight": 12.5, "unit": "kg", "stable": true}

// 格式2：简写格式
{"w": 12.5, "u": "kg", "s": true}

// 格式3：嵌套格式（凯丰）
{"data": {"value": 12.5, "unit": "kg", "stable": 1}}
```

**预期结果**：所有格式都能正确解析

---

## 📊 性能测试

### 响应时间测试

**测试工具**：浏览器开发者工具（F12 → Network标签）

**指标**：
- HTTP请求响应时间：< 100ms
- 重量数据更新频率：约500ms/次
- CPU占用率：< 10%
- 内存占用：< 200MB

**测试步骤**：
1. 打开浏览器开发者工具
2. 访问 `/hardware-test` 页面
3. 观察 `/api/weight` 请求的响应时间
4. 记录平均值和最大值

---

## 🔧 故障排查

### 问题1：连接失败

**症状**：点击"连接电子秤"后显示"连接失败"

**排查步骤**：
1. 检查IP地址是否正确
   ```bash
   ping 192.168.1.200
   ```
2. 检查端口是否开放
   ```bash
   telnet 192.168.1.200 80
   ```
3. 检查防火墙设置
4. 查看日志文件（`logs/`目录）

---

### 问题2：重量不更新

**症状**：连接成功，但重量数据不刷新

**排查步骤**：
1. 检查 `appsettings.json` 中的 `ReadIntervalMs` 配置
2. 打开浏览器开发者工具，查看是否有HTTP请求
3. 检查电子秤API是否返回数据
4. 查看后端日志（日志级别调整为Debug）

---

### 问题3：重量显示异常

**症状**：重量值不合理（负数、超大值、NaN等）

**排查步骤**：
1. 检查电子秤返回的数据格式
2. 验证单位转换逻辑
3. 检查是否正确去皮
4. 查看后端日志中的原始数据

---

## 📝 模拟电子秤API文档

### GET /api/weight

**功能**：获取当前重量数据

**请求示例**：
```http
GET http://localhost:8080/api/weight HTTP/1.1
```

**响应示例**（A&D格式）：
```json
{
  "weight": 12.35,
  "unit": "kg",
  "stable": true,
  "tare": 0.0,
  "timestamp": "2026-01-12T15:30:45.123Z"
}
```

**字段说明**：
- `weight`：净重（已去皮）
- `unit`：单位（kg或g）
- `stable`：是否稳定（true/false）
- `tare`：皮重值
- `timestamp`：时间戳

---

### POST /api/tare

**功能**：去皮（清零）

**请求示例**：
```http
POST http://localhost:8080/api/tare HTTP/1.1
Content-Type: application/json

{}
```

**响应示例**：
```json
{
  "success": true,
  "message": "去皮成功",
  "tare": 2.5
}
```

---

## 🎯 下一步计划

完成WiFi电子秤测试后，可以继续：

1. ✅ **集成到业务流程**：在称重记录模块中使用WiFi电子秤
2. ✅ **真实硬件测试**：使用实际的WiFi电子秤进行验证
3. ✅ **性能优化**：根据测试结果调整轮询频率和超时时间
4. ✅ **错误处理增强**：添加更详细的错误提示和自动重连机制

---

## 📞 技术支持

遇到问题？
- 查看项目日志：`logs/` 目录
- 查看后端日志级别：`appsettings.json` → `Logging:LogLevel`
- 调整为Debug级别：`"Minimes.Infrastructure.Hardware": "Debug"`

---

**文档版本**：v1.0
**最后更新**：2026-01-12
**作者**：老王技术流
